<!--Desenvolvido por Murillo Iamarino Caravita-->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Disciplinas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="/public/instiuicoescss.css" rel="stylesheet" />
</head>
<body>

  <!-- Navbar breadcrumb -->
  <nav class="navbar navbar-light bg-white fixed-top shadow-sm" style="height:56px; z-index:100;">
    <div class="container-fluid d-flex justify-content-between align-items-center px-4 w-100" style="padding-left:64px; padding-right:64px;">
      <div>
        <a href="/instituicoes" class="navbar-brand mb-0 h6 fw-bold text-primary me-1" style="letter-spacing:0.5px;">
          Instituições
        </a>
        <span class="navbar-text me-1" style="color:#999;">
          >
        </span>
        <!-- Alterado por JS -->
        <a href="#" class="navbar-brand mb-0 h6 fw-bold text-primary me-1" id="breadcrumbDisciplina">
          Cursos
        </a>
        <span class="navbar-text me-1" style="color:#999;">
          >
        </span>
        
        <span class="navbar-brand mb-0 h6 fw-semibold text-muted me-1" style="letter-spacing:0.5px">
          Disciplinas
        </span>
      </div>
      <span class="fw-light" style="color:#4d4d4d; font-size:1.4rem;">
        NotaDez
      </span>
    </div>
  </nav>

  <main class="dashboard-main pt-5">
    <div class="dashboard-title" id="mainTitle">Carregando...</div>
    <div class="dashboard-desc">Gerencie as disciplinas do curso</div>
    <div class="instituicoes-header" id="headerDisciplinas">Suas Disciplinas</div>
    <div class="instituicoes-wrapper" id="cardsContainer"></div>
  </main>

  <!-- Modal para adicionar disciplina -->
  <div class="modal fade" id="addDisciplinaModal" tabindex="-1" aria-labelledby="addDisciplinaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="addDisciplinaForm" class="modal-content" autocomplete="off">
        <div class="modal-header">
          <h5 class="modal-title" id="addDisciplinaModalLabel">Cadastrar Nova Disciplina</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="nomeDisciplinaInput" class="form-label">Nome da Disciplina</label>
            <input type="text" class="form-control" id="nomeDisciplinaInput" name="nome" required />
          </div>
          <div class="mb-3">
            <label for="siglaInput" class="form-label">Sigla</label>
            <input type="text" class="form-control" id="siglaInput" name="sigla" required />
          </div>
          <div class="mb-3">
            <label for="codigoInput" class="form-label">Código</label>
            <input type="text" class="form-control" id="codigoInput" name="codigo" />
          </div>
          <div class="mb-3">
            <label for="periodoInput" class="form-label">Período</label>
            <input type="text" class="form-control" id="periodoInput" name="periodo" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Cadastrar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal para editar disciplina -->
  <div class="modal fade" id="editDisciplinaModal" tabindex="-1" aria-labelledby="editDisciplinaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="editDisciplinaForm" class="modal-content" autocomplete="off">
        <div class="modal-header">
          <h5 class="modal-title" id="editDisciplinaModalLabel">Editar Disciplina</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="editNomeDisciplinaInput" class="form-label">Nome da Disciplina</label>
            <input type="text" class="form-control" id="editNomeDisciplinaInput" name="nome" required />
          </div>
          <div class="mb-3">
            <label for="editSiglaInput" class="form-label">Sigla</label>
            <input type="text" class="form-control" id="editSiglaInput" name="sigla" required />
          </div>
          <div class="mb-3">
            <label for="editCodigoInput" class="form-label">Código</label>
            <input type="text" class="form-control" id="editCodigoInput" name="codigo" />
          </div>
          <div class="mb-3">
            <label for="editPeriodoInput" class="form-label">Período</label>
            <input type="text" class="form-control" id="editPeriodoInput" name="periodo" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Salvar Alterações</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    const cardsContainer = document.getElementById('cardsContainer');
    const mainTitle = document.getElementById('mainTitle');
    const headerDisciplinas = document.getElementById('headerDisciplinas');
    const breadcrumbDisciplina = document.getElementById('breadcrumbDisciplina');
    const addDisciplinaModal = new bootstrap.Modal(document.getElementById('addDisciplinaModal'));
    const editDisciplinaModal = new bootstrap.Modal(document.getElementById('editDisciplinaModal'));
    const btnVoltarCursos = document.getElementById('btnVoltarCursos');

    let cursoId = null;
    let instituicaoId = null;
    let cursoNome = null;

    function renderAddCard() {
      const card = document.createElement('div');
      card.className = 'card-add-dashboard';
      card.innerHTML = `
        <div class="plus">+</div>
        <div class="title">Adicionar Disciplina</div>
        <div class="desc">Cadastre uma nova disciplina</div>
      `;
      card.onclick = async () => {
        addDisciplinaModal.show();
      };
      cardsContainer.appendChild(card);
    }

    const originalFetch = window.fetch;
    window.fetch = async function(...args) {
      const token = localStorage.getItem('token');
      
      if (token) {
        const [resource, config = {}] = args;
        
        if (!config.headers) {
          config.headers = {};
        }
        
        config.headers['Authorization'] = `Bearer ${token}`;
        args[1] = config;
      }
      
      return originalFetch.apply(this, args);
    };

    async function captureParams() {
      const url = new URLSearchParams(window.location.search);

      disciplinaId = url.get("disciplina_id");
      cursoId = url.get("curso_id");
      instituicaoId = url.get("instituicao_id");
      cursoNome = url.get("curso_nome");  // SEM "let"
      let disciplinaNome = url.get("disciplina_nome");

      // Buscar nome do curso se não veio por parâmetro
      if (!cursoNome && cursoId) {
        try {
          const token = localStorage.getItem("token");
          const res = await fetch(`/api/cursos/${cursoId}`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          if (res.ok) {
            const data = await res.json();
            cursoNome = data.nome;  // atualiza a global
          }
        } catch {}
      }

      // Buscar nome da disciplina se não veio por parâmetro
      if (!disciplinaNome && disciplinaId) {
        try {
          const token = localStorage.getItem("token");
          const res = await fetch(`/api/disciplinas/${disciplinaId}`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          if (res.ok) {
            const disciplina = await res.json();
            disciplinaNome = disciplina.nome;
          }
        } catch {}
      }

      // Atualizar breadcrumb do curso com link clicável
      const breadcrumbCurso = document.getElementById("breadcrumbDisciplina");
      if (breadcrumbCurso) {
        breadcrumbCurso.textContent = cursoNome || "Cursos";
        breadcrumbCurso.style.cursor = "pointer";
        breadcrumbCurso.onclick = (e) => {
          e.preventDefault();
          const token = localStorage.getItem('token');
          window.location.href = `/cursos/${instituicaoId}?token=${token}&instituicao_id=${instituicaoId}`;
        };

      }

      // Atualizar título principal
      mainTitle.textContent = cursoNome || "Disciplinas";
    }

    async function loadDisciplinas() {
      cardsContainer.innerHTML = '';
      try {
        const token = localStorage.getItem('token');
        let url = '/api/disciplinas';
        if (cursoId) {
          url += `?curso_id=${cursoId}`;
        }
        
        console.log('Chamando URL:', url);
        
        const res = await fetch(url, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error('Erro ao buscar disciplinas');
        const disciplinas = await res.json();

        console.log('Disciplinas retornadas:', disciplinas);

        if (disciplinas.length === 0) {
          // Renderiza apenas o card de adicionar, sem mensagem de vazio
          renderAddCard();
        } else {
          disciplinas.forEach(disciplina => {
            const card = document.createElement('div');
            card.className = 'card-dashboard';
            card.innerHTML = `
              <div class="title">${disciplina.nome}</div>
              <div class="desc">Sigla: ${disciplina.sigla}</div>
              <div class="badges">
                <span class="badge-custom">Código: ${disciplina.codigo || 'N/A'}</span>
                <span class="badge-custom">Período: ${disciplina.periodo || 'N/A'}</span>
              </div>
              <div class="actions">
                <button class="btn btn-slim btn-abrir">Abrir</button>
                <button class="btn btn-slim btn-editar">Editar</button>
                <button class="btn btn-slim btn-deletar">Deletar</button>
              </div>
            `;

            const token = localStorage.getItem('token');

            card.querySelector('.btn-abrir').onclick = () => {
              const token = localStorage.getItem('token');
              window.location.href = `/turmas?token=${token}&disciplina_id=${disciplina.id}&curso_id=${cursoId}&instituicao_id=${instituicaoId}`;
            };

            
            card.querySelector('.btn-editar').onclick = () => {
              abrirModalEditarDisciplina(disciplina);
            };
            
            card.querySelector('.btn-deletar').onclick = async () => {
              if (confirm(`Deseja excluir a disciplina ${disciplina.nome}?`)) {
                await fetch(`/api/disciplinas/${disciplina.id}`, {
                  method: 'DELETE',
                  headers: { 'Authorization': `Bearer ${token}` }
                });
                loadDisciplinas();
              }
            };

            cardsContainer.appendChild(card);
          });
          renderAddCard();
        }
      } catch(error) {
        const errorMessage = document.createElement('div');
        errorMessage.className = 'text-center my-5 text-danger';
        errorMessage.innerHTML = `<h4>Erro ao carregar disciplinas</h4>`;
        cardsContainer.appendChild(errorMessage);
        console.error(error);
      }
    }


    async function abrirModalEditarDisciplina(disciplina) {
      document.getElementById('editNomeDisciplinaInput').value = disciplina.nome;
      document.getElementById('editSiglaInput').value = disciplina.sigla;
      document.getElementById('editCodigoInput').value = disciplina.codigo || '';
      document.getElementById('editPeriodoInput').value = disciplina.periodo || '';
      document.getElementById('editDisciplinaForm').dataset.id = disciplina.id;
      editDisciplinaModal.show();
    }

    window.addEventListener('DOMContentLoaded', () => {
      captureParams();
      loadDisciplinas();
    });

    // Submissão do form de adição
    document.getElementById('addDisciplinaForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const data = {
        nome: form.nome.value.trim(),
        sigla: form.sigla.value.trim(),
        codigo: form.codigo.value.trim(),
        periodo: form.periodo.value.trim(),
        curso_id: cursoId
      };
      const token = localStorage.getItem('token');
      try {
        const res = await fetch('/api/disciplinas', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify(data)
        });
        if (!res.ok) {
          const errorData = await res.json();
          throw new Error(errorData.error || 'Falha ao cadastrar disciplina');
        }
        addDisciplinaModal.hide();
        form.reset();
        loadDisciplinas();
      } catch (err) {
        console.error('Erro:', err);
        alert('Erro ao cadastrar disciplina: ' + err.message);
      }
    });

    // Submissão do form de edição
    document.getElementById('editDisciplinaForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const id = form.dataset.id;
      const data = {
        nome: form.nome.value.trim(),
        sigla: form.sigla.value.trim(),
        codigo: form.codigo.value.trim(),
        periodo: form.periodo.value.trim()
      };
      const token = localStorage.getItem('token');
      try {
        const res = await fetch(`/api/disciplinas/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify(data)
        });
        if (!res.ok) {
          const errorData = await res.json();
          throw new Error(errorData.error || 'Falha ao editar disciplina');
        }
        editDisciplinaModal.hide();
        form.reset();
        loadDisciplinas();
      } catch (err) {
        console.error('Erro:', err);
        alert('Erro ao editar disciplina: ' + err.message);
      }
    });
  </script>
</body>
</html>
