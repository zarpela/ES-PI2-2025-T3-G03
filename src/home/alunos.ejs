<!--Desenvolvido por Guilherme Henrique Moreira-->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alunos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="/public/instiuicoescss.css" rel="stylesheet" />
</head>
<body>

  <!-- NAVBAR IGUAL AO DE DISCIPLINAS/TURMAS -->
  <nav class="navbar navbar-light bg-white fixed-top shadow-sm" style="height:56px; z-index:100;">
    <div class="container-fluid d-flex justify-content-between align-items-center px-4 w-100" style="padding-left:64px; padding-right:64px;">
      <div>
        <a href="/instituicoes" class="navbar-brand mb-0 h6 fw-bold text-primary me-1">Institui√ß√µes</a>
        <span class="navbar-text me-1" style="color:#999;"> &gt; </span>

        <a href="#" id="btnVoltarCursos" class="navbar-brand mb-0 h6 fw-bold text-primary me-1" style="cursor:pointer;">Cursos</a>
        <span class="navbar-text me-1" style="color:#999;"> &gt; </span>

        <a href="#" id="btnVoltarDisciplinas" class="navbar-brand mb-0 h6 fw-bold text-primary me-1" style="cursor:pointer;">Disciplinas</a>
        <span class="navbar-text me-1" style="color:#999;"> &gt; </span>

        <span class="navbar-brand mb-0 h6 fw-semibold text-muted me-3" id="breadcrumbAlunos" style="cursor:default;">
          Alunos
        </span>
      </div>

      <span class="fw-light" style="color:#4d4d4d; font-size:1.4rem;">NotaDez</span>
    </div>
  </nav>

  <main class="dashboard-main pt-5">

    <div class="d-flex justify-content-center mb-3 px-3">
      <div class="text-center">
        <div class="dashboard-title" id="mainTitle">Carregando...</div>
        <div class="dashboard-desc">Gerencie os alunos e componentes de nota</div>
      </div>
    </div>

    <div class="instituicoes-header text-center">Alunos</div>

    <div class="card p-3 mt-3 mx-3">
      <div class="table-responsive">
        <table class="table table-sm" id="notasTable">
          <thead id="tableHead"></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- === CONTROLES ABAIXO DA TABELA === -->
    <div class="d-flex justify-content-between align-items-center mt-3 px-3">
      <!-- ComboBox √† esquerda -->
      <div class="d-flex align-items-center gap-2">
        <select id="modoEdicao" class="form-select w-auto" onchange="alternarModoEdicao()">
          <!-- üî• MODO EXIBI√á√ÉO ADICIONADO AQUI -->
          <option value="exibicao" selected>Exibi√ß√£o</option>
          <option value="componente">Editar por componente</option>
          <option value="total">Edi√ß√£o Completa</option>
        </select>

        <select id="componenteSelecionado" class="form-select w-auto" onchange="habilitarSomenteUmComponente()">
          <!-- preenchido automaticamente -->
        </select>
      </div>

      <!-- Bot√µes √† direita -->
      <div class="d-flex flex-column gap-2">
        <div class="d-flex gap-2">
          <label class="btn btn-outline-secondary mb-0">
            Importar CSV <input id="csvFile" type="file" accept=".csv" hidden>
          </label>
          <button id="btnExportarCsv" class="btn btn-outline-success mb-0">Exportar CSV</button>
        </div>
        <div class="d-flex gap-2">
          <button id="btnCriarComponente" class="btn btn-primary">Novo componente</button>
          <button id="btnRemoverComponente" class="btn btn-danger">Remover componente</button>
        </div>
      </div>
    </div>
    <!-- =================================== -->
  </main>

  <!-- Modal: criar componente -->
  <div class="modal fade" id="componenteModal" tabindex="-1">
    <div class="modal-dialog">
      <form id="componenteForm" class="modal-content" autocomplete="off">
        <div class="modal-header">
          <h5 class="modal-title">Criar componente de nota</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Nome</label>
            <input type="text" class="form-control" id="compNome" name="nome" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Sigla (ex: P1)</label>
            <input type="text" class="form-control" id="compSigla" name="sigla" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Descri√ß√£o (opcional)</label>
            <textarea class="form-control" id="compDescricao" name="descricao"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-success" type="submit">Salvar componente</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: remover componente -->
  <div class="modal fade" id="removerComponenteModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Remover componente de nota</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Selecione o componente a ser removido</label>
            <select class="form-select" id="componenteRemoverSelect">
              <option value="">Selecione um componente...</option>
              <!-- preenchido automaticamente -->
            </select>
          </div>
          <div class="alert alert-warning">
            <strong>Aten√ß√£o:</strong> Esta a√ß√£o n√£o pode ser desfeita. Todas as notas relacionadas a este componente ser√£o removidas.
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-danger" type="button" id="btnConfirmarRemocao">Remover componente</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: mensagem simples -->
  <div class="modal fade" id="infoModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-body" id="infoModalBody"></div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const tableHead = document.getElementById('tableHead');
    const tableBody = document.getElementById('tableBody');
    const mainTitle = document.getElementById('mainTitle');
    const csvFile = document.getElementById('csvFile');
    const componenteModal = new bootstrap.Modal(document.getElementById('componenteModal'));
    const removerComponenteModal = new bootstrap.Modal(document.getElementById('removerComponenteModal'));
    const infoModal = new bootstrap.Modal(document.getElementById('infoModal'));
    const infoModalBody = document.getElementById('infoModalBody');

    let turmaId = null;
    let disciplinaId = null;
    let cursoId = null;
    let instituicaoId = null;
    let componentes = [];
    let formulaNotaFinal = null;

    function showInfo(msg) {
      infoModalBody.textContent = msg;
      infoModal.show();
    }

    function captureParams() {
      const params = new URLSearchParams(window.location.search);
      turmaId = params.get('turma_id');
      disciplinaId = params.get('disciplina_id');
      cursoId = params.get('curso_id');
      instituicaoId = params.get('instituicao_id');
      const disciplinaNome = params.get('disciplina_nome');
      const turmaNome = params.get('turma_nome');

      mainTitle.textContent = (turmaNome ? `${turmaNome}` : (disciplinaNome ? disciplinaNome : 'Alunos'));

      const btnVoltarCursos = document.getElementById('btnVoltarCursos');
      const btnVoltarDisciplinas = document.getElementById('btnVoltarDisciplinas');

      if (btnVoltarCursos) btnVoltarCursos.onclick = (e) => {
        e?.preventDefault();
        const token = localStorage.getItem('token');
        window.location.href = `/cursos/${instituicaoId}?token=${token}&instituicao_id=${instituicaoId}`;
      };

      if (btnVoltarDisciplinas) btnVoltarDisciplinas.onclick = (e) => {
        e?.preventDefault();
        const token = localStorage.getItem('token');
        window.location.href = `/disciplinas?token=${token}&curso_id=${cursoId}&instituicao_id=${instituicaoId}`;
      };
    }

    // MONTA CABE√áALHO
    function buildTableHeader(mostrarNotaFinal = false) {
      tableHead.innerHTML = '';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <th style="min-width:120px">Matr√≠cula</th>
        <th>Nome</th>
      `;
      componentes.forEach(c => {
        const th = document.createElement('th');
        th.textContent = c.sigla;
        tr.appendChild(th);
      });
      if (mostrarNotaFinal) {
        const th = document.createElement('th');
        th.textContent = 'Nota Final';
        th.style.fontWeight = 'bold';
        tr.appendChild(th);
      }
      tableHead.appendChild(tr);
    }

    async function loadComponentes() {
      componentes = [];
      if (!disciplinaId) return;
      const token = localStorage.getItem('token');
      try {
        const res = await fetch(`/api/componentes?disciplina_id=${disciplinaId}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!res.ok) return;
        componentes = await res.json();
      } catch (err) {
        console.error('Erro ao carregar componentes', err);
      }
    }

    async function loadFormulaNotaFinal() {
      if (!disciplinaId) return;
      const token = localStorage.getItem('token');
      try {
        const res = await fetch(`/api/formula-nota-final/${disciplinaId}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (res.ok) {
          formulaNotaFinal = await res.json();
        }
      } catch (err) {
        console.error('Erro ao carregar f√≥rmula:', err);
      }
    }

    function calcularNotaFinal(notasAluno) {
      if (!formulaNotaFinal || !formulaNotaFinal.expressao) {
        return null;
      }

      try {
        // Substituir as siglas dos componentes pelos valores das notas
        let expressao = formulaNotaFinal.expressao;
        
        // Verificar se todas as notas est√£o presentes
        for (const c of componentes) {
          const valor = notasAluno[c.sigla];
          if (valor === null || valor === undefined || valor === '') {
            return null; // Se alguma nota estiver faltando, n√£o calcula
          }
        }

        // Substituir as siglas pelos valores
        componentes.forEach(c => {
          const valor = notasAluno[c.sigla];
          // Substituir a sigla pelo valor (case insensitive, word boundary)
          const regex = new RegExp(`\\b${c.sigla}\\b`, 'gi');
          expressao = expressao.replace(regex, valor);
        });

        // Avaliar a express√£o matem√°tica de forma segura
        // Usar Function para evitar eval direto
        const resultado = Function('"use strict"; return (' + expressao + ')')();
        
        // Arredondar para 2 casas decimais
        return Math.round(resultado * 100) / 100;
      } catch (err) {
        console.error('Erro ao calcular nota final:', err, 'Express√£o:', formulaNotaFinal.expressao);
        return null;
      }
    }

    async function loadAlunos() {
      tableBody.innerHTML = '';
      if (!turmaId) {
        showInfo('turma_id n√£o fornecido na URL');
        return;
      }
      const token = localStorage.getItem('token');
      try {
        const res = await fetch(`/api/alunos?turma_id=${turmaId}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!res.ok) {
          showInfo('Erro ao carregar alunos');
          return;
        }
        const alunos = await res.json();

        if (alunos.length === 0) {
          const tr = document.createElement('tr');
          const colspan = 2 + componentes.length + (formulaNotaFinal && formulaNotaFinal.expressao ? 1 : 0);
          tr.innerHTML = `<td colspan="${colspan}" class="text-center text-muted">Nenhum aluno cadastrado</td>`;
          tableBody.appendChild(tr);
          return;
        }

        // Buscar notas existentes
        let notasExistentes = {};
        try {
          const notasRes = await fetch(`/api/notas/turma/${turmaId}`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          if (notasRes.ok) {
            const notas = await notasRes.json();
            notas.forEach(nota => {
              const key = `${nota.aluno_id}_${nota.componente_sigla}`;
              notasExistentes[key] = nota.valor;
            });
          }
        } catch (err) {
          console.error('Erro ao carregar notas:', err);
        }

        alunos.forEach(al => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${al.identificador}</td><td>${al.nome}</td>`;

          // Obter notas do aluno para c√°lculo
          const notasAluno = {};
          componentes.forEach(c => {
            const notaKey = `${al.id}_${c.sigla}`;
            notasAluno[c.sigla] = notasExistentes[notaKey] || null;
          });

          componentes.forEach(c => {
            const td = document.createElement('td');
            const notaKey = `${al.id}_${c.sigla}`;
            const valorNota = notasExistentes[notaKey] || '';

            /* === INPUT EDIT√ÅVEL === */
            const input = document.createElement('input');
            input.type = 'number';
            input.step = '0.01';
            input.min = '0';
            input.max = '10';
            input.className = `form-control form-control-sm nota-input nota-${c.sigla}`;
            input.dataset.componente = c.sigla;
            input.dataset.alunoId = al.id;
            input.value = valorNota;
            input.disabled = true;

            // Adicionar valida√ß√£o em tempo real
            input.addEventListener('input', (e) => {
              const inputEl = e.target;
              const valor = inputEl.value.trim();
              
              if (valor === '') {
                inputEl.classList.remove('is-invalid');
                return;
              }

              const valorNumerico = parseFloat(valor);
              if (isNaN(valorNumerico) || valorNumerico < 0 || valorNumerico > 10) {
                inputEl.classList.add('is-invalid');
              } else {
                inputEl.classList.remove('is-invalid');
              }
            });

            // Adicionar event listener para salvar nota quando o usu√°rio sair do campo
            input.addEventListener('blur', async (e) => {
              const inputEl = e.target;
              const valor = inputEl.value.trim();
              
              if (valor === '' || valor === null || valor === undefined) {
                inputEl.classList.remove('is-invalid');
                return; // N√£o salva se estiver vazio
              }

              const valorNumerico = parseFloat(valor);
              if (isNaN(valorNumerico)) {
                inputEl.classList.add('is-invalid');
                showInfo('Por favor, insira notas v√°lidas! (0-10)');
                inputEl.value = '';
                return;
              }

              if (valorNumerico < 0 || valorNumerico > 10) {
                inputEl.classList.add('is-invalid');
                showInfo('Por favor, insira notas v√°lidas! (0-10)');
                inputEl.value = '';
                return;
              }

              inputEl.classList.remove('is-invalid');

              const token = localStorage.getItem('token');
              try {
                const res = await fetch('/api/notas', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${token}`
                  },
                  body: JSON.stringify({
                    aluno_id: inputEl.dataset.alunoId,
                    turma_id: turmaId,
                    componente_sigla: inputEl.dataset.componente,
                    valor: valorNumerico
                  })
                });

                const data = await res.json();
                if (!res.ok) {
                  throw new Error(data.error || 'Erro ao salvar nota');
                }
                
                // Atualizar nota final se houver f√≥rmula
                if (formulaNotaFinal && formulaNotaFinal.expressao) {
                  const tr = inputEl.closest('tr');
                  const notaFinalTd = tr.querySelector('td:last-child');
                  if (notaFinalTd) {
                    // Recalcular notas do aluno
                    const notasAluno = {};
                    componentes.forEach(c => {
                      const notaInput = tr.querySelector(`.nota-${c.sigla}`);
                      notasAluno[c.sigla] = notaInput ? parseFloat(notaInput.value) || null : null;
                    });
                    const notaFinal = calcularNotaFinal(notasAluno);
                    const inputNotaFinal = notaFinalTd.querySelector('input');
                    if (inputNotaFinal) {
                      inputNotaFinal.value = notaFinal !== null ? notaFinal.toFixed(2) : '‚Äî';
                    }
                  }
                }
              } catch (err) {
                console.error('Erro ao salvar nota:', err);
                showInfo('Erro ao salvar nota: ' + (err.message || err));
              }
            });

            td.appendChild(input);
            tr.appendChild(td);
          });

          // Adicionar coluna de Nota Final se houver f√≥rmula
          if (formulaNotaFinal && formulaNotaFinal.expressao) {
            const td = document.createElement('td');
            const notaFinal = calcularNotaFinal(notasAluno);
            const inputNotaFinal = document.createElement('input');
            inputNotaFinal.type = 'text';
            inputNotaFinal.className = 'form-control form-control-sm';
            inputNotaFinal.value = notaFinal !== null ? notaFinal.toFixed(2) : '‚Äî';
            inputNotaFinal.readOnly = true;
            inputNotaFinal.style.backgroundColor = '#f8f9fa';
            inputNotaFinal.style.fontWeight = 'bold';
            td.appendChild(inputNotaFinal);
            tr.appendChild(td);
          }

          tableBody.appendChild(tr);
        });
      } catch (err) {
        console.error('Erro ao carregar alunos', err);
        showInfo('Erro ao carregar alunos');
      }
    }

    // === MODO DE EDI√á√ÉO ===
    let componentesGlobais = [];

    function carregarSelectDeComponentes(componentes) {
      componentesGlobais = componentes;
      const select = document.getElementById("componenteSelecionado");
      select.innerHTML = "";

      componentes.forEach(c => {
        const op = document.createElement("option");
        op.value = c.sigla;
        op.textContent = c.sigla;
        select.appendChild(op);
      });

      habilitarSomenteUmComponente();
    }

    function alternarModoEdicao() {
      const modo = document.getElementById("modoEdicao").value;

      if (modo === "exibicao") {
        // üî• EXIBI√á√ÉO = TUDO DESABILITADO
        document.querySelectorAll(".nota-input").forEach(inp => inp.disabled = true);
        return;
      }

      if (modo === "total") {
        document.querySelectorAll(".nota-input").forEach(inp => inp.disabled = false);
        return;
      }

      // componente
      habilitarSomenteUmComponente();
    }

    function habilitarSomenteUmComponente() {
      const modo = document.getElementById("modoEdicao").value;

      if (modo !== "componente") return;

      const sigla = document.getElementById("componenteSelecionado").value;

      document.querySelectorAll(".nota-input").forEach(inp => {
        inp.disabled = inp.dataset.componente !== sigla;
      });
    }
    // ==========================

    // criar componente via modal
    document.getElementById('btnCriarComponente').addEventListener('click', () => componenteModal.show());
    document.getElementById('componenteForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const nome = document.getElementById('compNome').value.trim();
      const sigla = document.getElementById('compSigla').value.trim().toUpperCase();
      const descricao = document.getElementById('compDescricao').value.trim();

      if (!disciplinaId) { showInfo('disciplina_id ausente na URL'); return; }

      const token = localStorage.getItem('token');
      try {
        const res = await fetch('/api/componentes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
          body: JSON.stringify({ nome, sigla, descricao, disciplina_id: disciplinaId })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Erro');

        componenteModal.hide();
        document.getElementById('compNome').value = '';
        document.getElementById('compSigla').value = '';
        document.getElementById('compDescricao').value = '';

        await init();
        showInfo('Componente criado com sucesso');

      } catch (err) {
        console.error(err);
        showInfo('Erro ao criar componente: ' + (err.message || err));
      }
    });

    // remover componente via modal
    document.getElementById('btnRemoverComponente').addEventListener('click', () => {
      const select = document.getElementById('componenteRemoverSelect');
      select.innerHTML = '<option value="">Selecione um componente...</option>';
      
      if (componentes.length === 0) {
        showInfo('N√£o h√° componentes para remover');
        return;
      }

      componentes.forEach(c => {
        const op = document.createElement('option');
        op.value = c.id;
        op.textContent = `${c.sigla} - ${c.nome}`;
        select.appendChild(op);
      });

      removerComponenteModal.show();
    });

    document.getElementById('btnConfirmarRemocao').addEventListener('click', async () => {
      const componenteId = document.getElementById('componenteRemoverSelect').value;
      
      if (!componenteId) {
        showInfo('Selecione um componente para remover');
        return;
      }

      if (!confirm('Tem certeza que deseja remover este componente? Esta a√ß√£o n√£o pode ser desfeita.')) {
        return;
      }

      const token = localStorage.getItem('token');
      try {
        const res = await fetch(`/api/componentes/${componenteId}`, {
          method: 'DELETE',
          headers: { Authorization: `Bearer ${token}` }
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Erro ao remover componente');

        removerComponenteModal.hide();
        document.getElementById('componenteRemoverSelect').value = '';

        await init();
        showInfo('Componente removido com sucesso');

      } catch (err) {
        console.error(err);
        showInfo('Erro ao remover componente: ' + (err.message || err));
      }
    });

    csvFile.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      if (!confirm(`Enviar CSV para a turma?`)) {
        csvFile.value = '';
        return;
      }

      const formData = new FormData();
      formData.append('file', file);
      const token = localStorage.getItem('token');

      try {
        const res = await fetch(`/notas/turma/${turmaId}/importar-alunos-csv`, {
          method: 'POST',
          headers: { Authorization: `Bearer ${token}` },
          body: formData
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Erro na importa√ß√£o');

        showInfo(`Importa√ß√£o conclu√≠da ‚Äî inseridos: ${data.adicionados || 0}, pulados: ${data.errosDeLogica || 0}`);
        csvFile.value = '';
        await init();

      } catch (err) {
        console.error(err);
        showInfo('Erro ao importar CSV: ' + (err.message || err));
        csvFile.value = '';
      }
    });

    // Exportar CSV
    document.getElementById('btnExportarCsv').addEventListener('click', async () => {
      if (!turmaId) {
        showInfo('turma_id n√£o fornecido na URL');
        return;
      }

      if (componentes.length === 0) {
        showInfo('N√£o h√° componentes cadastrados para exportar');
        return;
      }

      const token = localStorage.getItem('token');
      
      // Garantir que a f√≥rmula esteja carregada
      if (!formulaNotaFinal && disciplinaId) {
        await loadFormulaNotaFinal();
      }
      
      try {
        const res = await fetch(`/api/notas/turma/${turmaId}`, {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || 'Erro ao buscar notas');
        }

        const notas = await res.json();

        // Organizar notas por aluno
        const notasPorAluno = {};
        notas.forEach(nota => {
          const key = `${nota.aluno_id}_${nota.identificador}_${nota.nome}`;
          if (!notasPorAluno[key]) {
            notasPorAluno[key] = {
              identificador: nota.identificador,
              nome: nota.nome,
              notas: {}
            };
          }
          // Armazenar o valor da nota (pode ser null se n√£o houver nota)
          notasPorAluno[key].notas[nota.componente_sigla] = nota.valor;
        });

        // Validar se todas as notas est√£o preenchidas e s√£o v√°lidas
        const alunos = Object.values(notasPorAluno);
        
        for (const aluno of alunos) {
          for (const componente of componentes) {
            const valor = aluno.notas[componente.sigla];
            
            // Verificar se a nota est√° preenchida
            // Considera v√°lido: n√∫meros (incluindo 0), strings num√©ricas n√£o vazias
            // Considera inv√°lido: null, undefined, string vazia, string '-'
            if (valor === null || valor === undefined || valor === '' || valor === '-') {
              showInfo('S√≥ √© poss√≠vel realizar a exporta√ß√£o quando todos os componentes possu√≠rem nota lan√ßada');
              return;
            }
            
            // Verificar se √© um n√∫mero v√°lido (mesmo que seja string num√©rica)
            const valorNumerico = parseFloat(valor);
            if (isNaN(valorNumerico)) {
              showInfo('S√≥ √© poss√≠vel realizar a exporta√ß√£o quando todos os componentes possu√≠rem nota lan√ßada');
              return;
            }

            // Verificar se a nota est√° no range v√°lido (0-10)
            if (valorNumerico < 0 || valorNumerico > 10) {
              showInfo('Por favor, insira notas v√°lidas! (0-10)');
              return;
            }
          }
        }

        // Gerar CSV
        const headers = ['Matr√≠cula', 'Nome', ...componentes.map(c => c.sigla)];
        
        // Adicionar coluna de Nota Final se houver f√≥rmula
        if (formulaNotaFinal && formulaNotaFinal.expressao) {
          headers.push('Nota Final');
        }
        
        const rows = alunos.map(aluno => {
          const linha = [
            aluno.identificador,
            aluno.nome,
            ...componentes.map(c => aluno.notas[c.sigla] || '')
          ];
          
          // Adicionar nota final se houver f√≥rmula
          if (formulaNotaFinal && formulaNotaFinal.expressao) {
            const notaFinal = calcularNotaFinal(aluno.notas);
            linha.push(notaFinal !== null ? notaFinal.toFixed(2) : '‚Äî');
          }
          
          return linha.map(campo => {
            // Escapar campos que cont√™m v√≠rgula ou aspas
            if (typeof campo === 'string' && (campo.includes(',') || campo.includes('"') || campo.includes('\n'))) {
              return `"${campo.replace(/"/g, '""')}"`;
            }
            return campo;
          }).join(',');
        });

        const csvContent = [headers.join(','), ...rows].join('\n');

        // Gerar nome do arquivo: YYYY-MM-DD_HHmmssms-TurmaX_Sigla.csv
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        const milliseconds = String(now.getMilliseconds()).padStart(3, '0');
        
        const params = new URLSearchParams(window.location.search);
        const turmaNome = params.get('turma_nome') || `Turma${turmaId}`;
        
        // Buscar sigla da disciplina
        let disciplinaSigla = 'SIGLA';
        if (disciplinaId) {
          try {
            const disciplinaRes = await fetch(`/api/disciplinas/${disciplinaId}`, {
              headers: { Authorization: `Bearer ${token}` }
            });
            if (disciplinaRes.ok) {
              const disciplina = await disciplinaRes.json();
              disciplinaSigla = disciplina.sigla || 'SIGLA';
            }
          } catch (err) {
            console.error('Erro ao buscar sigla da disciplina:', err);
          }
        }
        
        const fileName = `${year}-${month}-${day}_${hours}${minutes}${seconds}${milliseconds}-${turmaNome}_${disciplinaSigla}.csv`;

        // Fazer download
        const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showInfo('CSV exportado com sucesso');

      } catch (err) {
        console.error(err);
        showInfo('Erro ao exportar CSV: ' + (err.message || err));
      }
    });

    async function init() {
      await loadComponentes();
      await loadFormulaNotaFinal();
      buildTableHeader(formulaNotaFinal && formulaNotaFinal.expressao);
      await loadAlunos();
      carregarSelectDeComponentes(componentes);

      // üî• DEIXAR EXIBI√á√ÉO COMO PADR√ÉO
      document.getElementById("modoEdicao").value = "exibicao";
      alternarModoEdicao();
    }

    window.addEventListener('DOMContentLoaded', () => {
      captureParams();
      init();
    });
  </script>
</body>
</html>
