<!--Desenvolvido por Guilherme Henrique Moreira-->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alunos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="/public/instiuicoescss.css" rel="stylesheet" />
</head>
<body>

  <!-- NAVBAR PADRÃO -->
  <nav class="navbar navbar-light bg-white fixed-top shadow-sm" style="height:56px; z-index:100;">
    <div class="container-fluid d-flex justify-content-between align-items-center px-4 w-100" style="padding-left:64px; padding-right:64px;">
      <div>
        <a href="/instituicoes" class="navbar-brand mb-0 h6 fw-bold text-primary me-1" style="letter-spacing:0.5px;">
          Instituições
        </a>
        <span class="navbar-text me-1" style="color:#999;"> &gt; </span>

        <a href="#" id="btnVoltarCursos" class="navbar-brand mb-0 h6 fw-bold text-primary me-1" style="cursor:pointer;">
          Cursos
        </a>
        <span class="navbar-text me-1" style="color:#999;"> &gt; </span>

        <a href="#" id="btnVoltarDisciplinas" class="navbar-brand mb-0 h6 fw-bold text-primary me-1" style="cursor:pointer;">
          Disciplinas
        </a>
        <span class="navbar-text me-1" style="color:#999;"> &gt; </span>

        <a href="#" id="btnVoltarTurmas" class="navbar-brand mb-0 h6 fw-bold text-primary me-1" style="cursor:pointer;">
          Turmas
        </a>
        <span class="navbar-text me-1" style="color:#999;"> &gt; </span>

        <span id="breadcrumbAlunos" class="navbar-brand mb-0 h6 fw-bold text-muted me-3" style="cursor:default;">
          Alunos
        </span>
      </div>
      <span class="fw-light" style="color:#4d4d4d; font-size:1.4rem;">
        NotaDez
      </span>
    </div>
  </nav>

  <main class="dashboard-main pt-5">

     <div class="d-flex justify-content-center mb-3 px-3">
      <div class="text-center">
        <div class="dashboard-title" id="mainTitle">Carregando...</div>
        <div class="dashboard-desc">Gerencie os alunos e componentes de nota</div>
      </div>
    </div>


    <div class="instituicoes-header text-center">Alunos</div>


    <!-- Botões Adicionar e Remover aluno -->
    <div class="d-flex justify-content-start gap-2 mt-3 px-3">
      <button id="btnAdicionarAluno" class="btn btn-primary">Adicionar Aluno</button>
      <button id="btnRemoverAluno" class="btn btn-danger">Remover Aluno</button>
    </div>


    <div class="card p-3 mt-3 mx-0">

      <!-- Contêiner flex para tabela e painel de auditoria lado a lado -->
      <div class="d-flex gap-3 mt-3 mx-3">
        <!-- Tabela de notas -->
        <div class="card p-3 flex-grow-1">
          <div class="table-responsive">
            <table class="table table-sm" id="notasTable">
              <thead id="tableHead"></thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Painel de auditoria recolhível (Sidebar) -->
        <div id="auditoriaPanel" class="card p-3" style="width: 350px; max-height: 600px; overflow-y: auto; display: none; position: relative;">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0 fw-bold">Auditoria</h6>
            <button class="btn btn-sm btn-outline-secondary" onclick="toggleAuditoria()" style="padding: 0.25rem 0.5rem;">
              <span>✕</span>
            </button>
          </div>
          <div id="auditoriaContent" class="small">
            <p class="text-muted text-center">Carregando...</p>
          </div>
        </div>
      </div>

      <!-- Botão para mostrar/ocultar painel de auditoria -->
      <div class="d-flex justify-content-end mt-2 px-3">
        <button id="btnToggleAuditoria" class="btn btn-sm btn-outline-primary" onclick="toggleAuditoria()">
          Mostrar Auditoria
        </button>
      </div>
    </div>


    <!-- === CONTROLES ABAIXO DA TABELA === -->
    <div class="d-flex justify-content-between align-items-center mt-3 px-3">
      <!-- ComboBox à esquerda -->
      <div class="d-flex align-items-center gap-2">
        <select id="modoEdicao" class="form-select w-auto" onchange="alternarModoEdicao()">
          <!-- MODO EXIBIÇÃO ADICIONADO AQUI -->
          <option value="exibicao" selected>Exibição</option>
          <option value="componente">Editar por componente</option>
          <option value="total">Edição Completa</option>
        </select>

        <select id="componenteSelecionado" class="form-select w-auto" onchange="habilitarSomenteUmComponente()">
          <!-- preenchido automaticamente -->
        </select>
      </div>

      <!-- Botões à direita -->
      <div class="d-flex flex-column gap-2">
        <div class="d-flex gap-2 flex-wrap">
          <label class="btn btn-outline-secondary mb-0">
            Importar CSV <input id="csvFile" type="file" accept=".csv" hidden>
          </label>
          <button id="btnExportarCsv" class="btn btn-outline-success mb-0">Exportar CSV</button>
          <label class="btn btn-outline-secondary mb-0">
            Importar JSON <input id="jsonFile" type="file" accept=".json" hidden>
          </label>
          <button id="btnExportarJson" class="btn btn-outline-success mb-0">Exportar JSON</button>
        </div>
        <div class="d-flex gap-2">
          <button id="btnCriarComponente" class="btn btn-primary">Novo componente</button>
          <button id="btnRemoverComponente" class="btn btn-danger">Remover componente</button>
        </div>
      </div>
    </div>
    <!-- =================================== -->
  </main>

  <!-- Modal: criar componente -->
  <div class="modal fade" id="componenteModal" tabindex="-1">
    <div class="modal-dialog">
      <form id="componenteForm" class="modal-content" autocomplete="off">
        <div class="modal-header">
          <h5 class="modal-title">Criar componente de nota</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Nome</label>
            <input type="text" class="form-control" id="compNome" name="nome" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Sigla (ex: P1)</label>
            <input type="text" class="form-control" id="compSigla" name="sigla" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Descrição (opcional)</label>
            <textarea class="form-control" id="compDescricao" name="descricao"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-success" type="submit">Salvar componente</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: remover componente -->
  <div class="modal fade" id="removerComponenteModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Remover componente de nota</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Selecione o componente a ser removido</label>
            <select class="form-select" id="componenteRemoverSelect">
              <option value="">Selecione um componente...</option>
              <!-- preenchido automaticamente -->
            </select>
          </div>
          <div class="alert alert-warning">
            <strong>Atenção:</strong> Esta ação não pode ser desfeita. Todas as notas relacionadas a este componente serão removidas.
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-danger" type="button" id="btnConfirmarRemocao">Remover componente</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: mensagem simples -->
  <div class="modal fade" id="infoModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-body" id="infoModalBody"></div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Adicionar Aluno -->
  <div class="modal fade" id="adicionarAlunoModal" tabindex="-1">
    <div class="modal-dialog">
      <form id="adicionarAlunoForm" class="modal-content" autocomplete="off">
        <div class="modal-header">
          <h5 class="modal-title">Adicionar Aluno</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Matrícula</label>
            <input type="text" class="form-control" id="alunoMatricula" name="identificador" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Nome do Aluno</label>
            <input type="text" class="form-control" id="alunoNome" name="nome" required>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-success" type="submit">Adicionar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Remover Aluno -->
  <div class="modal fade" id="removerAlunoModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Remover Aluno</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Selecione o aluno a ser removido</label>
            <select class="form-select" id="alunoRemoverSelect">
              <option value="">Selecione um aluno...</option>
            </select>
          </div>
          <div class="alert alert-warning">
            <strong>Atenção:</strong> O aluno será removido da turma. Esta ação não pode ser desfeita.
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-danger" type="button" id="btnConfirmarRemocaoAluno">Remover Aluno</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const tableHead = document.getElementById('tableHead');
    const tableBody = document.getElementById('tableBody');
    const mainTitle = document.getElementById('mainTitle');
    const csvFile = document.getElementById('csvFile');
    const jsonFile = document.getElementById('jsonFile');
    const componenteModal = new bootstrap.Modal(document.getElementById('componenteModal'));
    const removerComponenteModal = new bootstrap.Modal(document.getElementById('removerComponenteModal'));
    const infoModal = new bootstrap.Modal(document.getElementById('infoModal'));
    const infoModalBody = document.getElementById('infoModalBody');

    let turmaId = null;
    let disciplinaId = null;
    let cursoId = null;
    let instituicaoId = null;
    let componentes = [];
    let formulaNotaFinal = null;

    // Função para alternar visibilidade do painel de auditoria
    function toggleAuditoria() {
      const panel = document.getElementById('auditoriaPanel');
      const btn = document.getElementById('btnToggleAuditoria');
      
      if (panel.style.display === 'none') {
        panel.style.display = 'block';
        btn.textContent = 'Oultar Auditoria';
        loadAuditoria();
      } else {
        panel.style.display = 'none';
        btn.textContent = 'Mostrar Auditoria';
      }
    }

    // Função para carregar logs de auditoria
    async function loadAuditoria() {
      const content = document.getElementById('auditoriaContent');
      content.innerHTML = '<p class="text-muted text-center">Carregando...</p>';

      if (!turmaId) {
        content.innerHTML = '<p class="text-muted text-center">Turma não identificada</p>';
        return;
      }

      const token = localStorage.getItem('token');
      try {
        const res = await fetch(`/api/auditoria/${turmaId}`, {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (!res.ok) {
          throw new Error('Erro ao carregar auditoria');
        }

        const logs = await res.json();

        if (logs.length === 0) {
          content.innerHTML = '<p class="text-muted text-center">Nenhum registro de auditoria</p>';
          return;
        }

        // Renderizar logs
        let html = '<div class="list-group list-group-flush">';
        logs.forEach(log => {
          const dataHora = new Date(log.data_hora);
          const dataFormatada = dataHora.toLocaleString('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
          });

          let mensagem = '';
          if (log.operacao === 'INSERT') {
            mensagem = `Nota ${log.componente_sigla} lançada: ${log.valor_novo}`;
          } else if (log.operacao === 'UPDATE') {
            mensagem = `Nota ${log.componente_sigla} alterada de ${log.valor_antigo} para ${log.valor_novo}`;
          }

          html += `
            <div class="list-group-item list-group-item-action p-2 mb-2 border rounded">
              <div class="d-flex w-100 justify-content-between">
                <small class="text-muted">${dataFormatada}</small>
              </div>
              <p class="mb-1 small"><strong>${log.aluno_nome}</strong></p>
              <small>${mensagem}</small>
            </div>
          `;
        });
        html += '</div>';

        content.innerHTML = html;
      } catch (err) {
        console.error('Erro ao carregar auditoria:', err);
        content.innerHTML = '<p class="text-danger text-center">Erro ao carregar auditoria</p>';
      }
    }

    function showInfo(msg) {
      infoModalBody.textContent = msg;
      infoModal.show();
    }

    // Pega os parametros para usar no backend
    async function captureParams() {
      const params = new URLSearchParams(window.location.search);
      turmaId = params.get('turma_id');
      disciplinaId = params.get('disciplina_id');
      cursoId = params.get('curso_id');
      instituicaoId = params.get('instituicao_id');
      let turmaNome = params.get('turma_nome');
      let disciplinaNome = params.get('disciplina_nome');
      let cursoNome = params.get('curso_nome');

      const token = localStorage.getItem('token');

      // Se não veio nome do curso, busca no backend
      if (!cursoNome && cursoId) {
        try {
          const res = await fetch(`/api/cursos/${cursoId}`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          if (res.ok) {
            const data = await res.json();
            cursoNome = data.nome;
          }
        } catch (e) { console.error(e); }
      }

      // Se não veio nome da disciplina, busca no backend
      if (!disciplinaNome && disciplinaId) {
        try {
          const res = await fetch(`/api/disciplinas/${disciplinaId}`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          if (res.ok) {
            const data = await res.json();
            disciplinaNome = data.nome;
          }
        } catch(e) { console.error(e); }
      }

      // Se não veio nome da turma, busca no backend
      if (!turmaNome && turmaId) {
        try {
          const res = await fetch(`/api/turmas/${turmaId}`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          if (res.ok) {
            const data = await res.json();
            turmaNome = data.nome;
          }
        } catch(e) { console.error(e); }
      }

      // Atualiza textos na navbar
      const btnVoltarCursos = document.getElementById('btnVoltarCursos');
      const btnVoltarDisciplinas = document.getElementById('btnVoltarDisciplinas');
      const btnVoltarTurmas = document.getElementById('btnVoltarTurmas');
      const breadcrumbAlunos = document.getElementById('breadcrumbAlunos');

      if (btnVoltarCursos) {
        btnVoltarCursos.textContent = cursoNome || 'Cursos';
        btnVoltarCursos.onclick = (e) => {
          e.preventDefault();
          window.location.href = `/cursos/${instituicaoId}?token=${token}&instituicao_id=${instituicaoId}`;
        };
      }

      if (btnVoltarDisciplinas) {
        btnVoltarDisciplinas.textContent = disciplinaNome || 'Disciplinas';
        btnVoltarDisciplinas.onclick = (e) => {
          e.preventDefault();
          window.location.href = `/disciplinas?token=${token}&curso_id=${cursoId}&instituicao_id=${instituicaoId}`;
        };
      }

      if (btnVoltarTurmas) {
        btnVoltarTurmas.textContent = turmaNome || 'Turmas';
        btnVoltarTurmas.onclick = (e) => {
          e.preventDefault();
          window.location.href = `/turmas?token=${token}&disciplina_id=${disciplinaId}&curso_id=${cursoId}&instituicao_id=${instituicaoId}`;
        };
      }

      if (breadcrumbAlunos) {
        breadcrumbAlunos.textContent = 'Alunos';
      }

      // Atualizar o título principal da página também
      if (mainTitle) {
        mainTitle.textContent = turmaNome || disciplinaNome || 'Alunos';
      }
    }


    window.addEventListener('DOMContentLoaded', async () => {
      await captureParams();
      await init();
    });


    // MONTA CABEÇALHO
    function buildTableHeader(mostrarNotaFinal = false) {
      tableHead.innerHTML = '';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <th style="min-width:120px">Matrícula</th>
        <th>Nome</th>
      `;
      componentes.forEach(c => {
        const th = document.createElement('th');
        th.textContent = c.sigla;
        tr.appendChild(th);
      });
      if (mostrarNotaFinal) {
        const th = document.createElement('th');
        th.textContent = 'Nota Final';
        th.style.fontWeight = 'bold';
        tr.appendChild(th);
      }
      tableHead.appendChild(tr);
    }

    async function loadComponentes() {
      componentes = [];
      if (!disciplinaId) return;
      const token = localStorage.getItem('token');
      try {
        const res = await fetch(`/api/componentes?disciplina_id=${disciplinaId}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!res.ok) return;
        componentes = await res.json();
      } catch (err) {
        console.error('Erro ao carregar componentes', err);
      }
    }

    async function loadFormulaNotaFinal() {
      if (!disciplinaId) return;
      const token = localStorage.getItem('token');
      try {
        const res = await fetch(`/api/formula-nota-final/${disciplinaId}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (res.ok) {
          formulaNotaFinal = await res.json();
        }
      } catch (err) {
        console.error('Erro ao carregar fórmula:', err);
      }
    }

    function calcularNotaFinal(notasAluno) {
      if (!formulaNotaFinal || !formulaNotaFinal.expressao) {
        return null;
      }

      try {
        // Substituir as siglas dos componentes pelos valores das notas
        let expressao = formulaNotaFinal.expressao;
        
        // Verificar se todas as notas estão presentes
        for (const c of componentes) {
          const valor = notasAluno[c.sigla];
          if (valor === null || valor === undefined || valor === '') {
            return null; // Se alguma nota estiver faltando, não calcula
          }
        }

        // Substituir as siglas pelos valores
        componentes.forEach(c => {
          const valor = notasAluno[c.sigla];
          // Substituir a sigla pelo valor (case insensitive, word boundary)
          const regex = new RegExp(`\\b${c.sigla}\\b`, 'gi');
          expressao = expressao.replace(regex, valor);
        });

        // Avaliar a expressão matemática de forma segura
        // Usar Function para evitar eval direto
        const resultado = Function('"use strict"; return (' + expressao + ')')();
        
        // Arredondar para 2 casas decimais
        return Math.round(resultado * 100) / 100;
      } catch (err) {
        console.error('Erro ao calcular nota final:', err, 'Expressão:', formulaNotaFinal.expressao);
        return null;
      }
    }

    async function loadAlunos() {
      tableBody.innerHTML = '';
      if (!turmaId) {
        showInfo('turma_id não fornecido na URL');
        return;
      }
      const token = localStorage.getItem('token');
      try {
        const res = await fetch(`/api/alunos?turma_id=${turmaId}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!res.ok) {
          showInfo('Erro ao carregar alunos');
          return;
        }
        const alunos = await res.json();

        if (alunos.length === 0) {
          const tr = document.createElement('tr');
          const colspan = 2 + componentes.length + (formulaNotaFinal && formulaNotaFinal.expressao ? 1 : 0);
          tr.innerHTML = `<td colspan="${colspan}" class="text-center text-muted">Nenhum aluno cadastrado</td>`;
          tableBody.appendChild(tr);
          return;
        }

        // Buscar notas existentes
        let notasExistentes = {};
        try {
          const notasRes = await fetch(`/api/notas/turma/${turmaId}`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          if (notasRes.ok) {
            const notas = await notasRes.json();
            notas.forEach(nota => {
              const key = `${nota.aluno_id}_${nota.componente_sigla}`;
              notasExistentes[key] = nota.valor;
            });
          }
        } catch (err) {
          console.error('Erro ao carregar notas:', err);
        }

        alunos.forEach(al => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${al.identificador}</td><td>${al.nome}</td>`;

          // Obter notas do aluno para cálculo
          const notasAluno = {};
          componentes.forEach(c => {
            const notaKey = `${al.id}_${c.sigla}`;
            notasAluno[c.sigla] = notasExistentes[notaKey] || null;
          });

          componentes.forEach(c => {
            const td = document.createElement('td');
            const notaKey = `${al.id}_${c.sigla}`;
            const valorNota = notasExistentes[notaKey] || '';

            /* === INPUT EDITÁVEL === */
            const input = document.createElement('input');
            input.type = 'number';
            input.step = '0.01';
            input.min = '0';
            input.max = '10';
            input.className = `form-control form-control-sm nota-input nota-${c.sigla}`;
            input.dataset.componente = c.sigla;
            input.dataset.alunoId = al.id;
            input.value = valorNota;
            input.disabled = true;

            // Adicionar validação em tempo real
            input.addEventListener('input', (e) => {
              const inputEl = e.target;
              const valor = inputEl.value.trim();
              
              if (valor === '') {
                inputEl.classList.remove('is-invalid');
                return;
              }

              const valorNumerico = parseFloat(valor);
              if (isNaN(valorNumerico) || valorNumerico < 0 || valorNumerico > 10) {
                inputEl.classList.add('is-invalid');
              } else {
                inputEl.classList.remove('is-invalid');
              }
            });

            // Adicionar event listener para salvar nota quando o usuário sair do campo
            input.addEventListener('blur', async (e) => {
              const inputEl = e.target;
              const valor = inputEl.value.trim();
              
              if (valor === '' || valor === null || valor === undefined) {
                inputEl.classList.remove('is-invalid');
                return; // Não salva se estiver vazio
              }

              const valorNumerico = parseFloat(valor);
              if (isNaN(valorNumerico)) {
                inputEl.classList.add('is-invalid');
                showInfo('Por favor, insira notas válidas! (0-10)');
                inputEl.value = '';
                return;
              }

              if (valorNumerico < 0 || valorNumerico > 10) {
                inputEl.classList.add('is-invalid');
                showInfo('Por favor, insira notas válidas! (0-10)');
                inputEl.value = '';
                return;
              }

              inputEl.classList.remove('is-invalid');

              const token = localStorage.getItem('token');
              try {
                const res = await fetch('/api/notas', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${token}`
                  },
                  body: JSON.stringify({
                    aluno_id: inputEl.dataset.alunoId,
                    turma_id: turmaId,
                    componente_sigla: inputEl.dataset.componente,
                    valor: valorNumerico
                  })
                });

                const data = await res.json();
                if (!res.ok) {
                  throw new Error(data.error || 'Erro ao salvar nota');
                }
                
                // Recarregar auditoria se o painel estiver visível
                const auditoriaPanel = document.getElementById('auditoriaPanel');
                if (auditoriaPanel && auditoriaPanel.style.display !== 'none') {
                  loadAuditoria();
                }
                
                // Atualizar nota final se houver fórmula
                if (formulaNotaFinal && formulaNotaFinal.expressao) {
                  const tr = inputEl.closest('tr');
                  const notaFinalTd = tr.querySelector('td:last-child');
                  if (notaFinalTd) {
                    // Recalcular notas do aluno
                    const notasAluno = {};
                    componentes.forEach(c => {
                      const notaInput = tr.querySelector(`.nota-${c.sigla}`);
                      notasAluno[c.sigla] = notaInput ? parseFloat(notaInput.value) || null : null;
                    });
                    const notaFinal = calcularNotaFinal(notasAluno);
                    const inputNotaFinal = notaFinalTd.querySelector('input');
                    if (inputNotaFinal) {
                      inputNotaFinal.value = notaFinal !== null ? notaFinal.toFixed(2) : '—';
                    }
                  }
                }
              } catch (err) {
                console.error('Erro ao salvar nota:', err);
                showInfo('Erro ao salvar nota: ' + (err.message || err));
              }
            });

            td.appendChild(input);
            tr.appendChild(td);
          });

          // Adicionar coluna de Nota Final se houver fórmula
          if (formulaNotaFinal && formulaNotaFinal.expressao) {
            const td = document.createElement('td');
            const notaFinal = calcularNotaFinal(notasAluno);
            const inputNotaFinal = document.createElement('input');
            inputNotaFinal.type = 'text';
            inputNotaFinal.className = 'form-control form-control-sm';
            inputNotaFinal.value = notaFinal !== null ? notaFinal.toFixed(2) : '—';
            inputNotaFinal.readOnly = true;
            inputNotaFinal.style.backgroundColor = '#f8f9fa';
            inputNotaFinal.style.fontWeight = 'bold';
            td.appendChild(inputNotaFinal);
            tr.appendChild(td);
          }

          tableBody.appendChild(tr);
        });
      } catch (err) {
        console.error('Erro ao carregar alunos', err);
        showInfo('Erro ao carregar alunos');
      }
    }

    // === MODO DE EDIÇÃO ===
    let componentesGlobais = [];

    function carregarSelectDeComponentes(componentes) {
      componentesGlobais = componentes;
      const select = document.getElementById("componenteSelecionado");
      select.innerHTML = "";

      componentes.forEach(c => {
        const op = document.createElement("option");
        op.value = c.sigla;
        op.textContent = c.sigla;
        select.appendChild(op);
      });

      habilitarSomenteUmComponente();
    }

    function alternarModoEdicao() {
      const modo = document.getElementById("modoEdicao").value;

      if (modo === "exibicao") {
        // EXIBIÇÃO = TUDO DESABILITADO
        document.querySelectorAll(".nota-input").forEach(inp => inp.disabled = true);
        return;
      }

      if (modo === "total") {
        document.querySelectorAll(".nota-input").forEach(inp => inp.disabled = false);
        return;
      }

      // componente
      habilitarSomenteUmComponente();
    }

    function habilitarSomenteUmComponente() {
      const modo = document.getElementById("modoEdicao").value;

      if (modo !== "componente") return;

      const sigla = document.getElementById("componenteSelecionado").value;

      document.querySelectorAll(".nota-input").forEach(inp => {
        inp.disabled = inp.dataset.componente !== sigla;
      });
    }
    // ==========================

    // criar componente via modal
    document.getElementById('btnCriarComponente').addEventListener('click', () => componenteModal.show());
    document.getElementById('componenteForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const nome = document.getElementById('compNome').value.trim();
      const sigla = document.getElementById('compSigla').value.trim().toUpperCase();
      const descricao = document.getElementById('compDescricao').value.trim();

      if (!disciplinaId) { showInfo('disciplina_id ausente na URL'); return; }

      const token = localStorage.getItem('token');
      try {
        const res = await fetch('/api/componentes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
          body: JSON.stringify({ nome, sigla, descricao, disciplina_id: disciplinaId })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Erro');

        componenteModal.hide();
        document.getElementById('compNome').value = '';
        document.getElementById('compSigla').value = '';
        document.getElementById('compDescricao').value = '';

        await init();
        showInfo('Componente criado com sucesso');

      } catch (err) {
        console.error(err);
        showInfo('Erro ao criar componente: ' + (err.message || err));
      }
    });

    // remover componente via modal
    document.getElementById('btnRemoverComponente').addEventListener('click', () => {
      const select = document.getElementById('componenteRemoverSelect');
      select.innerHTML = '<option value="">Selecione um componente...</option>';
      
      if (componentes.length === 0) {
        showInfo('Não há componentes para remover');
        return;
      }

      componentes.forEach(c => {
        const op = document.createElement('option');
        op.value = c.id;
        op.textContent = `${c.sigla} - ${c.nome}`;
        select.appendChild(op);
      });

      removerComponenteModal.show();
    });

    document.getElementById('btnConfirmarRemocao').addEventListener('click', async () => {
      const componenteId = document.getElementById('componenteRemoverSelect').value;
      
      if (!componenteId) {
        showInfo('Selecione um componente para remover');
        return;
      }

      if (!confirm('Tem certeza que deseja remover este componente? Esta ação não pode ser desfeita.')) {
        return;
      }

      const token = localStorage.getItem('token');
      try {
        const res = await fetch(`/api/componentes/${componenteId}`, {
          method: 'DELETE',
          headers: { Authorization: `Bearer ${token}` }
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Erro ao remover componente');

        removerComponenteModal.hide();
        document.getElementById('componenteRemoverSelect').value = '';

        await init();
        showInfo('Componente removido com sucesso');

      } catch (err) {
        console.error(err);
        showInfo('Erro ao remover componente: ' + (err.message || err));
      }
    });

    csvFile.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      if (!confirm(`Enviar CSV para a turma?`)) {
        csvFile.value = '';
        return;
      }

      const formData = new FormData();
      formData.append('file', file);
      const token = localStorage.getItem('token');

      try {
        const res = await fetch(`/api/turmas/${turmaId}/import`, {
          method: 'POST',
          headers: { Authorization: `Bearer ${token}` },
          body: formData
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Erro na importação');

        showInfo(`Importação concluída — inseridos: ${data.adicionados || 0}, pulados: ${data.errosDeLogica || 0}`);
        csvFile.value = '';
        await init();

      } catch (err) {
        console.error(err);
        showInfo('Erro ao importar CSV: ' + (err.message || err));
        csvFile.value = '';
      }
    });

    // Exportar CSV
    document.getElementById('btnExportarCsv').addEventListener('click', async () => {
      if (!turmaId) {
        showInfo('turma_id não fornecido na URL');
        return;
      }

      if (componentes.length === 0) {
        showInfo('Não há componentes cadastrados para exportar');
        return;
      }

      const token = localStorage.getItem('token');
      
      // Garantir que a fórmula esteja carregada
      if (!formulaNotaFinal && disciplinaId) {
        await loadFormulaNotaFinal();
      }
      
      try {
        const res = await fetch(`/api/notas/turma/${turmaId}`, {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || 'Erro ao buscar notas');
        }

        const notas = await res.json();

        // Organizar notas por aluno
        const notasPorAluno = {};
        notas.forEach(nota => {
          const key = `${nota.aluno_id}_${nota.identificador}_${nota.nome}`;
          if (!notasPorAluno[key]) {
            notasPorAluno[key] = {
              identificador: nota.identificador,
              nome: nota.nome,
              notas: {}
            };
          }
          // Armazenar o valor da nota (pode ser null se não houver nota)
          notasPorAluno[key].notas[nota.componente_sigla] = nota.valor;
        });

        // Validar se todas as notas estão preenchidas e são válidas
        const alunos = Object.values(notasPorAluno);
        
        for (const aluno of alunos) {
          for (const componente of componentes) {
            const valor = aluno.notas[componente.sigla];
            
            // Verificar se a nota está preenchida
            // Considera válido: números (incluindo 0), strings numéricas não vazias
            // Considera inválido: null, undefined, string vazia, string '-'
            if (valor === null || valor === undefined || valor === '' || valor === '-') {
              showInfo('Só é possível realizar a exportação quando todos os componentes possuírem nota lançada');
              return;
            }
            
            // Verificar se é um número válido (mesmo que seja string numérica)
            const valorNumerico = parseFloat(valor);
            if (isNaN(valorNumerico)) {
              showInfo('Só é possível realizar a exportação quando todos os componentes possuírem nota lançada');
              return;
            }

            // Verificar se a nota está no range válido (0-10)
            if (valorNumerico < 0 || valorNumerico > 10) {
              showInfo('Por favor, insira notas válidas! (0-10)');
              return;
            }
          }
        }

        // Gerar CSV
        const headers = ['Matrícula', 'Nome', ...componentes.map(c => c.sigla)];
        
        // Adicionar coluna de Nota Final se houver fórmula
        if (formulaNotaFinal && formulaNotaFinal.expressao) {
          headers.push('Nota Final');
        }
        
        const rows = alunos.map(aluno => {
          const linha = [
            aluno.identificador,
            aluno.nome,
            ...componentes.map(c => aluno.notas[c.sigla] || '')
          ];
          
          // Adicionar nota final se houver fórmula
          if (formulaNotaFinal && formulaNotaFinal.expressao) {
            const notaFinal = calcularNotaFinal(aluno.notas);
            linha.push(notaFinal !== null ? notaFinal.toFixed(2) : '—');
          }
          
          return linha.map(campo => {
            // Escapar campos que contêm vírgula ou aspas
            if (typeof campo === 'string' && (campo.includes(',') || campo.includes('"') || campo.includes('\n'))) {
              return `"${campo.replace(/"/g, '""')}"`;
            }
            return campo;
          }).join(',');
        });

        const csvContent = [headers.join(','), ...rows].join('\n');

        // Gerar nome do arquivo: YYYY-MM-DD_HHmmssms-TurmaX_Sigla.csv
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        const milliseconds = String(now.getMilliseconds()).padStart(3, '0');
        
        const params = new URLSearchParams(window.location.search);
        const turmaNome = params.get('turma_nome') || `Turma${turmaId}`;
        
        // Buscar sigla da disciplina
        let disciplinaSigla = 'SIGLA';
        if (disciplinaId) {
          try {
            const disciplinaRes = await fetch(`/api/disciplinas/${disciplinaId}`, {
              headers: { Authorization: `Bearer ${token}` }
            });
            if (disciplinaRes.ok) {
              const disciplina = await disciplinaRes.json();
              disciplinaSigla = disciplina.sigla || 'SIGLA';
            }
          } catch (err) {
            console.error('Erro ao buscar sigla da disciplina:', err);
          }
        }
        
        const fileName = `${year}-${month}-${day}_${hours}${minutes}${seconds}${milliseconds}-${turmaNome}_${disciplinaSigla}.csv`;

        // Fazer download
        const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showInfo('CSV exportado com sucesso');

      } catch (err) {
        console.error(err);
        showInfo('Erro ao exportar CSV: ' + (err.message || err));
      }
    });

    // Importar JSON (alunos)
    jsonFile.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      if (!confirm(`Enviar JSON para a turma?`)) {
        jsonFile.value = '';
        return;
      }

      const reader = new FileReader();
      reader.onload = async (event) => {
        try {
          const text = event.target && event.target.result ? String(event.target.result) : '';
          const jsonData = JSON.parse(text);

          if (!Array.isArray(jsonData)) {
            showInfo('O arquivo JSON deve conter um array de alunos');
            jsonFile.value = '';
            return;
          }

          const token = localStorage.getItem('token');
          const res = await fetch(`/api/turmas/${turmaId}/import-json`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${token}`
            },
            body: JSON.stringify(jsonData)
          });

          const data = await res.json();
          if (!res.ok) throw new Error(data.message || 'Erro na importação');

          showInfo(`Importação concluída — inseridos: ${data.adicionados || 0}, pulados: ${data.errosDeLogica || 0}`);
          jsonFile.value = '';
          await init();
        } catch (err) {
          console.error(err);
          showInfo('Erro ao importar JSON: ' + (err.message || err));
          jsonFile.value = '';
        }
      };
      reader.readAsText(file);
    });

    // Exportar JSON (notas por aluno)
    document.getElementById('btnExportarJson').addEventListener('click', async () => {
      if (!turmaId) {
        showInfo('turma_id não fornecido na URL');
        return;
      }

      if (componentes.length === 0) {
        showInfo('Não há componentes cadastrados para exportar');
        return;
      }

      const token = localStorage.getItem('token');
      if (!formulaNotaFinal && disciplinaId) {
        await loadFormulaNotaFinal();
      }

      try {
        const res = await fetch(`/api/notas/turma/${turmaId}`, {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || 'Erro ao buscar notas');
        }

        const notas = await res.json();

        const notasPorAluno = {};
        notas.forEach(nota => {
          const key = `${nota.aluno_id}_${nota.identificador}_${nota.nome}`;
          if (!notasPorAluno[key]) {
            notasPorAluno[key] = {
              identificador: nota.identificador,
              nome: nota.nome,
              notas: {}
            };
          }
          notasPorAluno[key].notas[nota.componente_sigla] = nota.valor;
        });

        const alunos = Object.values(notasPorAluno);
        for (const aluno of alunos) {
          for (const componente of componentes) {
            const valor = aluno.notas[componente.sigla];
            if (valor === null || valor === undefined || valor === '' || valor === '-') {
              showInfo('Só é possível realizar a exportação quando todos os componentes possuírem nota lançada');
              return;
            }
            const valorNumerico = parseFloat(valor);
            if (isNaN(valorNumerico) || valorNumerico < 0 || valorNumerico > 10) {
              showInfo('Por favor, insira notas válidas! (0-10)');
              return;
            }
          }
        }

        const jsonExport = alunos.map(aluno => {
          const out = {
            identificador: aluno.identificador,
            nome: aluno.nome
          };
          componentes.forEach(c => {
            out[c.sigla] = aluno.notas[c.sigla] ?? null;
          });
          if (formulaNotaFinal && formulaNotaFinal.expressao) {
            const notaFinal = calcularNotaFinal(aluno.notas);
            out['nota_final'] = notaFinal !== null ? Number(notaFinal.toFixed(2)) : null;
          }
          return out;
        });

        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        const milliseconds = String(now.getMilliseconds()).padStart(3, '0');

        const params = new URLSearchParams(window.location.search);
        const turmaNome = params.get('turma_nome') || `Turma${turmaId}`;

        let disciplinaSigla = 'SIGLA';
        if (disciplinaId) {
          try {
            const disciplinaRes = await fetch(`/api/disciplinas/${disciplinaId}`, {
              headers: { Authorization: `Bearer ${token}` }
            });
            if (disciplinaRes.ok) {
              const disciplina = await disciplinaRes.json();
              disciplinaSigla = disciplina.sigla || 'SIGLA';
            }
          } catch (err) {
            console.error('Erro ao buscar sigla da disciplina:', err);
          }
        }

        const fileName = `${year}-${month}-${day}_${hours}${minutes}${seconds}${milliseconds}-${turmaNome}_${disciplinaSigla}.json`;
        const blob = new Blob([JSON.stringify(jsonExport, null, 2)], { type: 'application/json;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showInfo('JSON exportado com sucesso');
      } catch (err) {
        console.error(err);
        showInfo('Erro ao exportar JSON: ' + (err.message || err));
      }
    });

    async function init() {
      await loadComponentes();
      await loadFormulaNotaFinal();
      buildTableHeader(formulaNotaFinal && formulaNotaFinal.expressao);
      await loadAlunos();
      carregarSelectDeComponentes(componentes);

      // DEIXAR EXIBIÇÃO COMO PADRÃO
      document.getElementById("modoEdicao").value = "exibicao";
      alternarModoEdicao();
    }

    const adicionarAlunoModal = new bootstrap.Modal(document.getElementById('adicionarAlunoModal'));
    const removerAlunoModal = new bootstrap.Modal(document.getElementById('removerAlunoModal'));

    // Abrir modal de adicionar aluno
    document.getElementById('btnAdicionarAluno').addEventListener('click', () => {
      adicionarAlunoModal.show();
    });

    // Adicionar aluno
    document.getElementById('adicionarAlunoForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const identificador = document.getElementById('alunoMatricula').value.trim();
      const nome = document.getElementById('alunoNome').value.trim();

      if (!identificador || !nome) {
        showInfo('Preencha todos os campos');
        return;
      }

      if (!turmaId) {
        showInfo('turma_id não fornecido');
        return;
      }

      const token = localStorage.getItem('token');
      try {
        const res = await fetch('/api/alunos', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify({
            identificador,
            nome,
            turma_id: turmaId
          })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Erro ao adicionar aluno');

        adicionarAlunoModal.hide();
        document.getElementById('alunoMatricula').value = '';
        document.getElementById('alunoNome').value = '';

        await init();
        showInfo('Aluno adicionado com sucesso');

      } catch (err) {
        console.error(err);
        showInfo('Erro ao adicionar aluno: ' + (err.message || err));
      }
    });

    // Abrir modal de remover aluno
    document.getElementById('btnRemoverAluno').addEventListener('click', async () => {
      if (!turmaId) {
        showInfo('turma_id não fornecido');
        return;
      }

      const token = localStorage.getItem('token');
      try {
        const res = await fetch(`/api/alunos?turma_id=${turmaId}`, {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (!res.ok) throw new Error('Erro ao buscar alunos');

        const alunos = await res.json();

        const select = document.getElementById('alunoRemoverSelect');
        select.innerHTML = '<option value="">Selecione um aluno...</option>';

        if (alunos.length === 0) {
          showInfo('Não há alunos cadastrados na turma');
          return;
        }

        alunos.forEach(aluno => {
          const option = document.createElement('option');
          option.value = aluno.id;
          option.textContent = `${aluno.identificador} - ${aluno.nome}`;
          select.appendChild(option);
        });

        removerAlunoModal.show();

      } catch (err) {
        console.error(err);
        showInfo('Erro ao carregar alunos: ' + (err.message || err));
      }
    });

    // Confirmar remoção de aluno
    document.getElementById('btnConfirmarRemocaoAluno').addEventListener('click', async () => {
      const alunoId = document.getElementById('alunoRemoverSelect').value;

      if (!alunoId) {
        showInfo('Selecione um aluno para remover');
        return;
      }

      if (!confirm('Tem certeza que deseja remover este aluno da turma?')) {
        return;
      }

      const token = localStorage.getItem('token');
      try {
        const res = await fetch(`/api/alunos/${alunoId}?turma_id=${turmaId}`, {
          method: 'DELETE',
          headers: { Authorization: `Bearer ${token}` }
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Erro ao remover aluno');

        removerAlunoModal.hide();
        document.getElementById('alunoRemoverSelect').value = '';

        await init();
        showInfo('Aluno removido com sucesso');

      } catch (err) {
        console.error(err);
        showInfo('Erro ao remover aluno: ' + (err.message || err));
      }
    });

  </script>
</body>
</html>