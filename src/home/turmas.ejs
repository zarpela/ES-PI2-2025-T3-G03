<!--Desenvolvido por Guilherme Henrique Moreira-->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Turmas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="/public/instiuicoescss.css" rel="stylesheet" />
</head>
<body>

  <!-- NAVBAR IGUAL AO DE DISCIPLINAS -->
  <nav class="navbar navbar-light bg-white fixed-top shadow-sm" style="height:56px; z-index:100;">
    <div class="container-fluid d-flex justify-content-between align-items-center px-4 w-100" style="padding-left:64px; padding-right:64px;">

      <div>
        <!-- Instituições -->
        <a href="/instituicoes" class="navbar-brand mb-0 h6 fw-bold text-primary me-1" style="letter-spacing:0.5px;">
          Instituições
        </a>
        <span class="navbar-text me-1" style="color:#999;">></span>

        <!-- Cursos -->
        <a href="#" id="btnVoltarCursos" class="navbar-brand mb-0 h6 fw-bold text-primary me-1" style="letter-spacing:0.5px; cursor: pointer;">
          Cursos
        </a>
        <span class="navbar-text me-1" style="color:#999;">></span>

        <!-- Disciplina Selecionada -->
        <a href="#" id="breadcrumbDisciplinaSelecionada" class="navbar-brand mb-0 h6 fw-bold text-muted me-1" style="letter-spacing:0.5px; cursor: pointer;">
          -
        </a>
        <span class="navbar-text me-1" style="color:#999;">></span>


        <!-- Turmas -->
        <span id="breadcrumbTurmas" class="navbar-brand mb-0 h6 fw-semibold text-muted me-1" style="color:#999;">
          Turmas
        </span>
      </div>

      <span class="fw-light" style="color:#4d4d4d; font-size:1.4rem;">
        NotaDez
      </span>
    </div>
  </nav>

  <main class="dashboard-main pt-5">
    <div class="dashboard-title" id="mainTitle">Carregando...</div>
    <div class="dashboard-desc">Gerencie as turmas da disciplina</div>
    
    <!-- Campo para Fórmula de Nota Final -->
    <div class="card p-3 mt-3 mx-3 mb-3" id="formulaCard" style="display: none;">
      <h6 class="mb-3">Fórmula de Nota Final</h6>
      <div class="mb-2">
        <label class="form-label">Expressão matemática (ex: (P1 + P2 + P3) / 3)</label>
        <input type="text" class="form-control" id="formulaInput" placeholder="Ex: (P1 + P2 + P3) / 3">
        <small class="form-text text-muted">Use as siglas dos componentes cadastrados. Todos os componentes devem estar na fórmula.</small>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-primary btn-sm" id="btnSalvarFormula">Salvar Fórmula</button>
        <button class="btn btn-secondary btn-sm" id="btnCancelarFormula" style="display: none;">Cancelar</button>
      </div>
      <div id="formulaStatus" class="mt-2"></div>
    </div>
    
    <div class="instituicoes-header">Suas Turmas</div>
    <div class="instituicoes-wrapper" id="cardsContainer"></div>
  </main>

  <!-- Modal adicionar turma -->
  <div class="modal fade" id="addTurmaModal" tabindex="-1">
    <div class="modal-dialog">
      <form id="addTurmaForm" class="modal-content" autocomplete="off">
        <div class="modal-header">
          <h5 class="modal-title">Cadastrar Nova Turma</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">

          <div class="mb-3">
            <label class="form-label">Código</label>
            <input type="text" class="form-control" id="codigoTurmaInput" name="codigo" required />
          </div>

          <div class="mb-3">
            <label class="form-label">Nome da Turma</label>
            <input type="text" class="form-control" id="nomeTurmaInput" name="nome" required />
          </div>

          <div class="mb-3">
            <label class="form-label">Apelido (opcional)</label>
            <input type="text" class="form-control" id="apelidoTurmaInput" name="apelido" />
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Cadastrar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal editar -->
  <div class="modal fade" id="editTurmaModal" tabindex="-1">
    <div class="modal-dialog">
      <form id="editTurmaForm" class="modal-content" autocomplete="off">
        <div class="modal-header">
          <h5 class="modal-title">Editar Turma</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">

          <div class="mb-3">
            <label class="form-label">Código</label>
            <input type="text" class="form-control" id="editCodigoTurmaInput" name="codigo" required />
          </div>

          <div class="mb-3">
            <label class="form-label">Nome da Turma</label>
            <input type="text" class="form-control" id="editNomeTurmaInput" name="nome" required />
          </div>

          <div class="mb-3">
            <label class="form-label">Apelido (opcional)</label>
            <input type="text" class="form-control" id="editApelidoTurmaInput" name="apelido" />
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Salvar Alterações</button>
        </div>
      </form>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const cardsContainer = document.getElementById("cardsContainer");
    const addTurmaModal = new bootstrap.Modal(document.getElementById("addTurmaModal"));
    const editTurmaModal = new bootstrap.Modal(document.getElementById("editTurmaModal"));
    const mainTitle = document.getElementById("mainTitle");

    let disciplinaId = null;
    let cursoId = null;
    let instituicaoId = null;

    function renderAddCard() {
      const card = document.createElement("div");
      card.className = "card-add-dashboard";
      card.innerHTML = `
        <div class="plus">+</div>
        <div class="title">Adicionar Turma</div>
        <div class="desc">Cadastre uma nova turma</div>
      `;
      card.onclick = () => addTurmaModal.show();
      cardsContainer.appendChild(card);
    }

    async function captureParams() {
      const url = new URLSearchParams(window.location.search);

      disciplinaId = url.get("disciplina_id");
      cursoId = url.get("curso_id");
      instituicaoId = url.get("instituicao_id");
      let cursoNome = url.get("curso_nome");
      let disciplinaNome = url.get("disciplina_nome");

      // Buscar nome do curso se não veio por parâmetro
      if (!cursoNome && cursoId) {
        try {
          const token = localStorage.getItem("token");
          const res = await fetch(`/api/cursos/${cursoId}`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          if (res.ok) {
            const data = await res.json();
            cursoNome = data.nome;
          }
        } catch {}
      }

      // Se não veio o nome na URL, buscar no backend
      if (!disciplinaNome && disciplinaId) {
        const token = localStorage.getItem("token");
        try {
          const res = await fetch(`/api/disciplinas/${disciplinaId}`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          if (res.ok) {
            const disciplina = await res.json();
            disciplinaNome = disciplina.nome;
          }
        } catch {
          // Erro ao buscar, deixamos disciplinaNome sem alteração
        }
      }

      mainTitle.textContent = disciplinaNome || "Turmas";
      document.getElementById('breadcrumbDisciplinaSelecionada').textContent = disciplinaNome || "-";

      // Configuração dos botões "Voltar"
      btnVoltarCursos.onclick = () => {
        const token = localStorage.getItem("token");
        window.location.href = `/cursos/${instituicaoId}?token=${token}&instituicao_id=${instituicaoId}`;
      };

      btnVoltarDisciplinas.onclick = () => {
        const token = localStorage.getItem("token");
        window.location.href = `/disciplinas?token=${token}&curso_id=${cursoId}&instituicao_id=${instituicaoId}`;
      };
    }

    async function atualizarBreadcrumbDisciplina() {
      const url = new URLSearchParams(window.location.search);
      let disciplinaNome = url.get("disciplina_nome");
      const disciplinaId = url.get("disciplina_id");

      if (!disciplinaNome && disciplinaId) {
        // Busca pelo backend
        try {
          const token = localStorage.getItem("token");
          const res = await fetch(`/api/disciplinas/${disciplinaId}`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          if (res.ok) {
            const data = await res.json();
            disciplinaNome = data.nome;
          }
        } catch {}
      }

      // Atualiza a div ou span do breadcrumb na navbar
      document.getElementById('breadcrumbDisciplinaSelecionada').textContent = disciplinaNome || "-";
    }



    async function loadFormula() {
      if (!disciplinaId) return;
      
      const token = localStorage.getItem("token");
      try {
        // Verificar se há componentes cadastrados
        const componentesRes = await fetch(`/api/componentes?disciplina_id=${disciplinaId}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        
        if (!componentesRes.ok) return;
        const componentes = await componentesRes.json();
        
        if (componentes.length === 0) {
          document.getElementById('formulaCard').style.display = 'none';
          return;
        }
        
        // Mostrar o card de fórmula
        document.getElementById('formulaCard').style.display = 'block';
        
        // Carregar fórmula existente
        const formulaRes = await fetch(`/api/formula-nota-final/${disciplinaId}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        
        if (formulaRes.ok) {
          const formula = await formulaRes.json();
          if (formula && formula.expressao) {
            document.getElementById('formulaInput').value = formula.expressao;
            document.getElementById('formulaStatus').innerHTML = 
              `<span class="text-success">Fórmula salva: ${formula.expressao}</span>`;
          }
        }
      } catch (err) {
        console.error('Erro ao carregar fórmula:', err);
      }
    }

    async function salvarFormula() {
      if (!disciplinaId) return;
      
      const expressao = document.getElementById('formulaInput').value.trim();
      if (!expressao) {
        alert('Por favor, informe a fórmula');
        return;
      }
      
      const token = localStorage.getItem("token");
      try {
        const res = await fetch('/api/formula-nota-final', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify({
            disciplina_id: disciplinaId,
            expressao: expressao
          })
        });
        
        const data = await res.json();
        if (!res.ok) {
          alert(data.error || 'Erro ao salvar fórmula');
          return;
        }
        
        document.getElementById('formulaStatus').innerHTML = 
          `<span class="text-success">Fórmula salva com sucesso!</span>`;
      } catch (err) {
        console.error('Erro ao salvar fórmula:', err);
        alert('Erro ao salvar fórmula');
      }
    }

    async function loadTurmas() {
      cardsContainer.innerHTML = "";

      const token = localStorage.getItem("token");
      const res = await fetch(`/api/turmas?disciplina_id=${disciplinaId}`, {
        headers: { Authorization: `Bearer ${token}` }
      });

      if (!res.ok) return;

      const turmas = await res.json();

      if (turmas.length === 0) {
        renderAddCard();
        return;
      }

      turmas.forEach(turma => {
        const card = document.createElement("div");
        card.className = "card-dashboard";
        card.innerHTML = `
          <div class="title">${turma.nome} <small style="font-weight:400;">(${turma.apelido || "—"})</small></div>
          <div class="desc">Disciplina: ${turma.disciplina_nome || "N/A"}</div>
          <div class="badges">
            <span class="badge-custom">Código: ${turma.codigo}</span>
            <span class="badge-custom">ID: ${turma.id}</span>
          </div>
          <div class="actions">
            <button class="btn btn-slim btn-abrir">Alunos</button>
            <button class="btn btn-slim btn-editar">Editar</button>
            <button class="btn btn-slim btn-deletar">Deletar</button>
          </div>
        `;

        card.querySelector(".btn-abrir").onclick = () => {
          const token = localStorage.getItem("token");
          window.location.href =
            `/alunos?token=${token}&turma_id=${turma.id}&disciplina_id=${disciplinaId}&curso_id=${cursoId}&instituicao_id=${instituicaoId}`;
        };

        card.querySelector(".btn-editar").onclick = () => abrirModalEditar(turma);

        card.querySelector(".btn-deletar").onclick = async () => {
          if (!confirm(`Deseja excluir a turma ${turma.nome}?`)) return;

          const del = await fetch(`/api/turmas/${turma.id}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` }
          });

          if (del.ok) loadTurmas();
        };

        cardsContainer.appendChild(card);
      });

      renderAddCard();
    }

    async function atualizarBreadcrumbs() {
      const url = new URLSearchParams(window.location.search);

      let cursoNome = url.get("curso_nome");
      let disciplinaNome = url.get("disciplina_nome");
      const cursoId = url.get("curso_id");
      const disciplinaId = url.get("disciplina_id");

      if (!cursoNome && cursoId) {
        const token = localStorage.getItem("token");
        const resCurso = await fetch(`/api/cursos/${cursoId}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (resCurso.ok) {
          const curso = await resCurso.json();
          cursoNome = curso.nome;
        }
      }

      if (!disciplinaNome && disciplinaId) {
        const token = localStorage.getItem("token");
        const resDisciplina = await fetch(`/api/disciplinas/${disciplinaId}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (resDisciplina.ok) {
          const disciplina = await resDisciplina.json();
          disciplinaNome = disciplina.nome;
        }
      }

      document.getElementById("btnVoltarCursos").textContent = cursoNome || "Cursos";
      const elemento = document.getElementById("breadcrumbDisciplinaSelecionada");
      elemento.textContent = disciplinaNome || "-";
      elemento.style.cursor = "pointer"; // para deixar visual de clicável

      elemento.onclick = (e) => {
        e.preventDefault();
        // Lógica para navegar, ex:
        const token = localStorage.getItem("token");
        window.location.href = `/disciplinas?token=${token}&curso_id=${cursoId}&instituicao_id=${instituicaoId}`;
};
    }


    function abrirModalEditar(turma) {
      editCodigoTurmaInput.value = turma.codigo;
      editNomeTurmaInput.value = turma.nome;
      editApelidoTurmaInput.value = turma.apelido || "";
      editTurmaForm.dataset.id = turma.id;
      editTurmaModal.show();
    }

    document.getElementById("addTurmaForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const token = localStorage.getItem("token");

      const data = {
        codigo: codigoTurmaInput.value.trim(),
        nome: nomeTurmaInput.value.trim(),
        apelido: apelidoTurmaInput.value.trim(),
        disciplina_id: disciplinaId
      };

      const res = await fetch("/api/turmas", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify(data)
      });

      if (res.ok) {
        addTurmaModal.hide();
        loadTurmas();
      } else {
        alert("Erro ao cadastrar turma");
      }
    });

    document.getElementById("editTurmaForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = e.target.dataset.id;
      const token = localStorage.getItem("token");

      const data = {
        codigo: editCodigoTurmaInput.value.trim(),
        nome: editNomeTurmaInput.value.trim(),
        apelido: editApelidoTurmaInput.value.trim()
      };

      const res = await fetch(`/api/turmas/${id}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify(data)
      });

      if (res.ok) {
        editTurmaModal.hide();
        loadTurmas();
      } else {
        alert("Erro ao editar turma");
      }
    });

    // Event listener para salvar fórmula
    document.getElementById('btnSalvarFormula').addEventListener('click', salvarFormula);

    window.addEventListener("DOMContentLoaded", async () => {
      await atualizarBreadcrumbs();
      captureParams();
      await loadFormula();
      loadTurmas();
    });

  </script>

</body>
</html>
