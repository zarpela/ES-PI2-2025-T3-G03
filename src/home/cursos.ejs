<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cursos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="/public/instiuicoescss.css" rel="stylesheet" />
</head>
<body>

  <!-- Navbar topo igual Instituições -->
  <nav class="navbar navbar-light bg-white fixed-top shadow-sm" style="height:56px; z-index:100;">
    <div class="container-fluid d-flex justify-content-between align-items-center px-4 w-100" style="padding-left:64px; padding-right:64px;">
      <div>
        <a href="/instituicoes" class="navbar-brand mb-0 h6 fw-bold text-primary me-1" style="letter-spacing:0.5px;">
          Instituições
        </a>
        <span class="navbar-text me-1" style="color:#999;">
          >
        </span>
        <span class="navbar-brand mb-0 h6 fw-semibold text-muted me-3" style="letter-spacing:0.5px; cursor: default;">
          Cursos
        </span>
      </div>
      <span class="fw-light" style="color:#4d4d4d; font-size:1.4rem;">
        NotaDez
      </span>
    </div>
  </nav>

  <main class="dashboard-main pt-5">
    <div class="dashboard-title">Cursos</div>
    <div class="dashboard-desc">Gerencie seus cursos associados</div>
    <div class="instituicoes-header">Seus Cursos</div>
    <div class="instituicoes-wrapper" id="cardsContainer"></div>
  </main>

  <!-- Modal para adicionar curso -->
  <div class="modal fade" id="addCursoModal" tabindex="-1" aria-labelledby="addCursoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="addCursoForm" class="modal-content" autocomplete="off">
        <div class="modal-header">
          <h5 class="modal-title" id="addCursoModalLabel">Cadastrar Novo Curso</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="nomeCursoInput" class="form-label">Nome do Curso</label>
            <input type="text" class="form-control" id="nomeCursoInput" name="nome" required />
          </div>
          <div class="mb-3">
            <label for="instituicaoSelect" class="form-label">Instituição</label>
            <select class="form-select" id="instituicaoSelect" name="instituicao_id" required>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Cadastrar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal para editar curso -->
  <div class="modal fade" id="editCursoModal" tabindex="-1" aria-labelledby="editCursoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="editCursoForm" class="modal-content" autocomplete="off">
        <div class="modal-header">
          <h5 class="modal-title" id="editCursoModalLabel">Editar Curso</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="editNomeCursoInput" class="form-label">Nome do Curso</label>
            <input type="text" class="form-control" id="editNomeCursoInput" name="nome" required />
          </div>
          <div class="mb-3">
            <label for="editInstituicaoSelect" class="form-label">Instituição</label>
            <select class="form-select" id="editInstituicaoSelect" name="instituicao_id" required>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Salvar Alterações</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    const cardsContainer = document.getElementById('cardsContainer');
    const addCursoModal = new bootstrap.Modal(document.getElementById('addCursoModal'));
    const editCursoModal = new bootstrap.Modal(document.getElementById('editCursoModal'));

    async function loadInstituicoesSelect(selectId) {
      const token = localStorage.getItem('token');
      try {
        const res = await fetch('/api/instituicoes', { headers: { Authorization: `Bearer ${token}` } });
        if (!res.ok) return;
        const instituicoes = await res.json();
        const select = document.getElementById(selectId);
        select.innerHTML = '';
        instituicoes.forEach(inst => {
          const option = document.createElement('option');
          option.value = inst.id;
          option.textContent = inst.nome;
          select.appendChild(option);
        });
      } catch (err) {
        console.error('Erro ao carregar instituições', err);
      }
    }

    function renderAddCard() {
      const card = document.createElement('div');
      card.className = 'card-add-dashboard';
      card.innerHTML = `
        <div class="plus">+</div>
        <div class="title">Adicionar Curso</div>
        <div class="desc">Cadastre um novo curso</div>
      `;
      card.onclick = async () => {
        await loadInstituicoesSelect('instituicaoSelect');
        addCursoModal.show();
      };
      cardsContainer.appendChild(card);
    }

    async function loadCursos() {
      cardsContainer.innerHTML = '';
      try {
        const token = localStorage.getItem('token');
        
        // PEGA O instituicao_id DA URL
        const urlParams = new URLSearchParams(window.location.search);
        const instituicaoId = urlParams.get('instituicao_id');
        
        console.log('instituicao_id capturado:', instituicaoId);  // DEBUG
        
        // Monta a URL com o instituicao_id se ele existir
        let url = '/api/cursos';
        if (instituicaoId) {
          url += `?instituicao_id=${instituicaoId}`;
        }
        
        console.log('Chamando URL:', url);  // DEBUG
        
        const res = await fetch(url, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error('Erro ao buscar cursos');
        const cursos = await res.json();

        if (cursos.length === 0) {
          const emptyMessage = document.createElement('div');
          emptyMessage.className = 'text-center my-5';
          emptyMessage.innerHTML = `<h4 class="text-muted mb-3">Nenhum curso cadastrado</h4>`;
          cardsContainer.appendChild(emptyMessage);
        } else {
          cursos.forEach(curso => {
            const card = document.createElement('div');
            card.className = 'card-dashboard';
            card.innerHTML = `
              <div class="title">${curso.nome}</div>
              <div class="desc">Instituição: ${curso.instituicao_nome || 'Indefinida'}</div>
              <div class="actions">
                <button class="btn btn-slim btn-abrir">Abrir</button>
                <button class="btn btn-slim btn-editar">Editar</button>
                <button class="btn btn-slim btn-deletar">Deletar</button>
              </div>
            `;

            card.querySelector('.btn-abrir').onclick = () => {
              const token = localStorage.getItem('token');
              window.location.href = `/disciplinas?token=${token}&curso_id=${curso.id}&instituicao_id=${instituicaoId}&curso_nome=${encodeURIComponent(curso.nome)}`;
            };
            
            card.querySelector('.btn-editar').onclick = () => {
              abrirModalEditarCurso(curso);
            };
            
            card.querySelector('.btn-deletar').onclick = async () => {
              if (confirm(`Deseja excluir o curso ${curso.nome}?`)) {
                await fetch(`/api/cursos/${curso.id}`, {
                  method: 'DELETE',
                  headers: { 'Authorization': `Bearer ${token}` }
                });
                loadCursos();
              }
            };

            cardsContainer.appendChild(card);
          });
        }
        renderAddCard();
      } catch(error) {
        const errorMessage = document.createElement('div');
        errorMessage.className = 'text-center my-5 text-danger';
        errorMessage.innerHTML = `<h4>Erro ao carregar cursos</h4>`;
        cardsContainer.appendChild(errorMessage);
        console.error(error);
      }
    }


    async function abrirModalEditarCurso(curso) {
      await loadInstituicoesSelect('editInstituicaoSelect');
      document.getElementById('editNomeCursoInput').value = curso.nome;
      document.getElementById('editInstituicaoSelect').value = curso.instituicao_id || '';
      document.getElementById('editCursoForm').dataset.id = curso.id;
      editCursoModal.show();
    }

    window.addEventListener('DOMContentLoaded', loadCursos);

    // Submissão do form de adição
    document.getElementById('addCursoForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const data = {
        nome: form.nome.value.trim(),
        instituicao_id: form.instituicao_id.value,
      };
      const token = localStorage.getItem('token');
      try {
        const res = await fetch('/api/cursos', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify(data)
        });
        if (!res.ok) throw new Error('Falha ao cadastrar curso');
        addCursoModal.hide();
        form.reset();
        loadCursos();
      } catch (err) {
        alert('Erro ao cadastrar curso. Tente novamente.');
      }
    });

    // Submissão do form de edição
    document.getElementById('editCursoForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const id = form.dataset.id;
      const data = {
        nome: form.nome.value.trim(),
        instituicao_id: form.instituicao_id.value,
      };
      const token = localStorage.getItem('token');
      try {
        const res = await fetch(`/api/cursos/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify(data)
        });
        if (!res.ok) throw new Error('Falha ao editar curso');
        editCursoModal.hide();
        form.reset();
        loadCursos();
      } catch (err) {
        alert('Erro ao editar curso. Tente novamente.');
      }
    });
  </script>
</body>
</html>
