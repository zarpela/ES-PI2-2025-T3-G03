<!--Desenvolvido por Rafael Henrique dos Santos Inácio-->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Instituições</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="/public/instiuicoescss.css" rel="stylesheet">
</head>

<body>
  <!-- Navbar topo fixa style V3 -->
  <nav class="navbar navbar-light bg-white fixed-top shadow-sm" style="height:56px; z-index:100;">
    <div class="container-fluid d-flex justify-content-between align-items-center px-4 w-100" style="padding-left:64px; padding-right:64px;">

      <div>
        <a href="/instituicoes" class="navbar-brand mb-0 h6 fw-bold text-primary me-1" style="letter-spacing:0.5px;">
          Instituições
        </a>
      </div>

      <span class="fw-light" style="color:#4d4d4d; font-size:1.4rem;">
        NotaDez
      </span>

    </div>
  </nav>

  <main class="dashboard-main pt-5">
    <!-- Seção de instituições -->
    <div id="institutionsSection">
      <div class="dashboard-title">Bem-vindo, <span id="userName">Usuário</span></div>
      <div class="dashboard-desc">Gerencie suas instituições e organize suas turmas</div>
      <div class="instituicoes-header">Suas Instituições</div>
      <div class="instituicoes-wrapper" id="instituicoesWrapper"></div>
    </div>

    <!-- Seção de detalhes da instituição -->
    <div id="institutionDetails"></div>
  </main>

  <!-- Modal para adicionar instituição -->
  <div class="modal fade" id="addInstitutionModal" tabindex="-1" aria-labelledby="addInstitutionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="addInstitutionForm" class="modal-content" autocomplete="off">
        <div class="modal-header">
          <h5 class="modal-title" id="addInstitutionModalLabel">Cadastrar Nova Instituição</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="nomeInput" class="form-label">Nome da Instituição</label>
            <input type="text" class="form-control" id="nomeInput" name="nome" required />
          </div>
          <div class="mb-3">
            <label for="cnpjInput" class="form-label">CNPJ</label>
            <input type="text" class="form-control" id="cnpjInput" name="cnpj" required/>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Cadastrar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal para editar instituição -->
  <div class="modal fade" id="editInstitutionModal" tabindex="-1" aria-labelledby="editInstitutionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="editInstitutionForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Editar Instituição</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="editNomeInput" class="form-label">Nome da Instituição</label>
            <input type="text" class="form-control" id="editNomeInput" name="nome" required />
          </div>
          <div class="mb-3">
            <label for="editCnpjInput" class="form-label">CNPJ</label>
            <input type="text" class="form-control" id="editCnpjInput" name="cnpj" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Salvar Alterações</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    async function loadUserName() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('/api/usuario', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        if (!response.ok) throw new Error('Falha ao buscar nome do usuário');
        const user = await response.json();
        if (user.nome) {
          document.getElementById('userName').innerText = user.nome;
        }
      } catch (err) {
        console.error(err);
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      loadUserName();
    });

    async function loadInstituicoes() {
      wrapper.innerHTML = '';
      try {
        const token = localStorage.getItem('token');
        const res = await fetch('/api/instituicoes', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error();
        const instituicoes = await res.json();
        
        // Renderiza as instituições primeiro
        instituicoes.forEach((inst) => renderInstitutionCard(inst));
        
        // Depois renderiza o card de adicionar por último
        renderAddCard();
      } catch {
        wrapper.innerHTML = `<div class="text-danger my-5">Erro ao carregar instituições</div>`;
      }
    }

    document.addEventListener('DOMContentLoaded', loadInstituicoes);

    const wrapper = document.getElementById('instituicoesWrapper');
    const detailsContainer = document.getElementById('institutionDetails');
    const institutionsSection = document.getElementById('institutionsSection');

    function voltarParaInstituicoes() {
      detailsContainer.classList.remove('active');
      institutionsSection.style.display = 'block';
      detailsContainer.innerHTML = '';
    }

    async function renderInstitutionCard(inst) {
      const card = document.createElement('div');
      card.className = 'card-dashboard';
      
      // Busca as estatísticas
      let disciplinas = 0;
      let turmas = 0;
      try {
        const token = localStorage.getItem('token');
        const res = await fetch(`/api/instituicoes/${inst.id}/stats`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (res.ok) {
          const stats = await res.json();
          disciplinas = stats.disciplinas;
          turmas = stats.turmas;
        }
      } catch (err) {
        console.error('Erro ao buscar stats:', err);
      }
      
      card.innerHTML = `
        <div class="title">${inst.nome}</div>
        <div class="desc">${inst.cnpj ? inst.cnpj : ''}</div>
        <div class="badges">
          <span class="badge-custom">${disciplinas} disciplina(s)</span>
          <span class="badge-custom">${turmas} turma(s)</span>
        </div>
        <div class="actions">
          <button class="btn btn-slim btn-abrir">Abrir</button>
          <button class="btn btn-slim btn-editar">Editar</button>
          <button class="btn btn-slim btn-deletar">Deletar</button>
        </div>
      `;

      card.querySelector('.btn-abrir').onclick = () => {
        const token = localStorage.getItem('token');
        const id = inst.id;
        window.location.href = `/cursos/${id}?token=${token}&instituicao_id=${id}&instituicao_nome=${encodeURIComponent(inst.nome)}`;
      };
                                                                                                                                                                              
      card.querySelector('.btn-editar').onclick = () => abrirModalEditarInstituicao(inst);
      card.querySelector('.btn-deletar').onclick = async () => {
        if (confirm(`Deseja excluir a instituição ${inst.nome}?`)) {
          const token = localStorage.getItem('token');
          await fetch(`/api/instituicoes/${inst.id}`, {
            method: 'DELETE',
            headers: {'Authorization': `Bearer ${token}`}
          });
          loadInstituicoes();
        }
      };
      wrapper.appendChild(card);
    }

    function renderAddCard() {
      const card = document.createElement('div');
      card.className = 'card-add-dashboard';
      card.innerHTML = `
        <div class="plus">+</div>
        <div class="title">Adicionar Instituição</div>
        <div class="desc">Cadastre uma nova instituição</div>
      `;
      card.onclick = () => {
        const modal = new bootstrap.Modal(document.getElementById('addInstitutionModal'));
        modal.show();
      };
      wrapper.appendChild(card);
    }
    
    document.getElementById('addInstitutionForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const nome = e.target.nome.value.trim();
      const cnpj = e.target.cnpj.value.trim();
      if (!nome) {
        alert('O nome da instituição é obrigatório.');
        return;
      }
      const token = localStorage.getItem('token');
      try {
        const res = await fetch('/api/instituicoes', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ nome, cnpj })
        });
        if (!res.ok) throw new Error('Erro ao cadastrar instituição');
        loadInstituicoes();
        bootstrap.Modal.getInstance(document.getElementById('addInstitutionModal')).hide();
        e.target.reset();
      } catch (err) {
        alert('Erro ao cadastrar instituição. Tente novamente.');
      }
    });

    document.addEventListener('DOMContentLoaded', loadInstituicoes);

    function abrirModalEditarInstituicao(instituicao) {
      document.getElementById('editNomeInput').value = instituicao.nome || '';
      document.getElementById('editCnpjInput').value = instituicao.cnpj || '';
      document.getElementById('editInstitutionForm').dataset.id = instituicao.id;
      const editModal = new bootstrap.Modal(document.getElementById('editInstitutionModal'));
      editModal.show();
    }

    document.getElementById('editInstitutionForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const id = this.dataset.id;
      const nome = this.nome.value.trim();
      const cnpj = this.cnpj.value.trim();
      if (!nome) {
        alert('O nome da instituição é obrigatório.');
        return;
      }
      const token = localStorage.getItem('token');
      try {
        const res = await fetch(`/api/instituicoes/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ nome, cnpj })
        });
        if (!res.ok) throw new Error('Erro ao editar instituição');
        loadInstituicoes();
        voltarParaInstituicoes();
        bootstrap.Modal.getInstance(document.getElementById('editInstitutionModal')).hide();
        this.reset();
      } catch (err) {
        alert('Erro ao editar instituição. Tente novamente.');
      }
    });
  </script>
</body>
</html>
