<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
    crossorigin="anonymous"
  />

  <title>Recuperar Senha - NotaDez</title>

  <link rel="stylesheet" href="/public/base-cad-log.css" />
</head>

<body>
  <main class="container py-5 d-flex justify-content-center align-items-center">
    <form class="w-100" style="max-width: 400px;" id="form-recuperar">
      <h1 class="mb-4 text-center">Recuperar Senha</h1>
      
      <div class="mb-3" id="email-group">
        <label for="email-recuperar" class="form-label">Email</label>
        <input type="email" class="form-control" id="email-recuperar" placeholder="Digite o email cadastrado" required/>
      </div>

      <p id="mensagem-codigo" class="text-center text-success d-none">Um código foi enviado para seu e-mail.</p>

      <div class="mb-4 d-none" id="codigo-group">
        <label for="codigo-verificacao" class="form-label">Código de Verificação</label>
        <input type="text" class="form-control" id="codigo-verificacao" placeholder="Digite o código recebido"/>
      </div>

      <div class="d-grid gap-2 d-md-flex justify-content-md-end">
        <a href="/" type="button" class="btn btn-light mb-3">Voltar</a>
        <button type="submit" id="btn-enviar-email" class="btn btn-primary mb-3">Enviar</button>
        <button type="submit" id="btn-verificar-codigo" class="btn btn-primary mb-3 d-none">Verificar Código</button>
      </div>
    </form>
  </main>

  <script>
    // Seleciona os elementos do formulário
    const form = document.getElementById('form-recuperar');
    const emailInput = document.getElementById('email-recuperar');
    const codigoGroup = document.getElementById('codigo-group');
    const codigoInput = document.getElementById('codigo-verificacao');
    const mensagemCodigo = document.getElementById('mensagem-codigo');
    const btnEnviarEmail = document.getElementById('btn-enviar-email');
    const btnVerificarCodigo = document.getElementById('btn-verificar-codigo');
    const alertContainer = document.createElement('div'); // Container para alertas
    form.prepend(alertContainer);

    // Função para exibir alertas
    function showAlert(message, type = 'danger') {
        alertContainer.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
    }

    form.addEventListener('submit', async function(event) {
        event.preventDefault();
        alertContainer.innerHTML = ''; // Limpa alertas antigos

        if (!btnEnviarEmail.classList.contains('d-none')) {
            // --- Etapa 1: Enviar o Email ---
            try {
                const response = await fetch('/usuario/recuperar-senha', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: emailInput.value })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Erro ao solicitar recuperação de senha.');
                }

                // Atualiza a interface
                emailInput.disabled = true;
                btnEnviarEmail.classList.add('d-none');
                mensagemCodigo.textContent = data.message; // Usa a mensagem do backend
                mensagemCodigo.classList.remove('d-none');
                codigoGroup.classList.remove('d-none');
                btnVerificarCodigo.classList.remove('d-none');
                codigoInput.required = true;

            } catch (error) {
                showAlert(error.message);
            }

        } else {
            // --- Etapa 2: Verificar o Código ---
            try {
                const response = await fetch('/usuario/verificar-codigo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: emailInput.value,
                        code: codigoInput.value
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Erro ao verificar o código.');
                }
                
                // Sucesso!
                showAlert(data.message, 'success');
                // Opcional: redirecionar para a página de redefinição de senha
                // window.location.href = '/usuario/redefinir-senha?token=...';

            } catch (error) {
                showAlert(error.message);
            }
        }
    });
  </script>
</body>
</html>